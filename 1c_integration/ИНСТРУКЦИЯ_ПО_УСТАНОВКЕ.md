# Инструкция по установке интеграции 1С с системой бюджетирования

## Оглавление
1. [Общая информация](#общая-информация)
2. [Получение API токена](#получение-api-токена)
3. [Создание внешней обработки в 1С](#создание-внешней-обработки-в-1с)
4. [Добавление модуля обработки](#добавление-модуля-обработки)
5. [Создание формы обработки](#создание-формы-обработки)
6. [Настройка и тестирование](#настройка-и-тестирование)
7. [Автоматический режим работы](#автоматический-режим-работы)
8. [Устранение неполадок](#устранение-неполадок)

---

## Общая информация

Данная интеграция позволяет загружать обработанные счета из системы бюджетирования в 1С:Предприятие.

**Возможности:**
- Получение списка обработанных счетов из системы
- Просмотр детальной информации о каждом счете
- Создание документов в 1С на основе данных счета
- Отметка созданных счетов в системе бюджетирования
- Автоматическая обработка всех счетов одной кнопкой

**Технические требования:**
- 1С:Предприятие 8.3 (любая конфигурация)
- Доступ к интернету для подключения к API системы бюджетирования
- Права на создание внешних обработок

---

## Получение API токена

### Шаг 1: Авторизация в системе

1. Откройте веб-интерфейс системы бюджетирования
2. Войдите под учетной записью с правами **MANAGER** или **ADMIN**

### Шаг 2: Создание токена

1. Перейдите в раздел **"API Tokens"** (обычно в меню администрирования)
2. Нажмите кнопку **"Создать новый токен"**
3. Заполните форму:
   - **Название:** `1C Integration - [Ваше подразделение]`
   - **Scope:** `FULL_ACCESS` (для чтения и записи)
   - **Описание:** `Интеграция для загрузки счетов в 1С`
4. Нажмите **"Создать"**
5. **ВАЖНО:** Скопируйте сгенерированный токен - он показывается только один раз!

**Пример токена:** `tk_1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t`

---

## Создание внешней обработки в 1С

### Шаг 1: Открыть Конфигуратор

1. Запустите **1С:Предприятие** в режиме **Конфигуратор**
2. Откройте вашу информационную базу

### Шаг 2: Создать внешнюю обработку

1. В главном меню выберите: **Файл → Новый**
2. Выберите: **Внешняя обработка**
3. В появившемся окне введите:
   - **Имя:** `ОбработкаСчетовИзAPI`
   - **Синоним:** `Загрузка счетов из системы бюджетирования`
4. Нажмите **ОК**

### Шаг 3: Сохранить обработку

1. Нажмите **Ctrl+S** или выберите **Файл → Сохранить как**
2. Выберите папку для сохранения (рекомендуется: `ВнешниеОбработки/`)
3. Имя файла: `ОбработкаСчетовИзAPI.epf`
4. Нажмите **Сохранить**

---

## Добавление модуля обработки

### Шаг 1: Открыть модуль объекта

1. В окне обработки найдите в левой панели: **Модули → Модуль объекта**
2. Двойной клик по **"Модуль объекта"**

### Шаг 2: Вставить код

1. **Удалите** весь существующий код в модуле (если есть)
2. Откройте файл `ОбработкаСчетовИзAPI_v2.bsl` из папки интеграции
3. **Скопируйте** весь его содержимое
4. **Вставьте** в модуль объекта в 1С

### Шаг 3: Сохранить изменения

1. Нажмите **Ctrl+S** для сохранения
2. Проверьте, что **синтаксических ошибок нет** (должна быть зеленая галочка внизу)

---

## Создание формы обработки

### Метод 1: Импорт из XML (рекомендуется)

#### Шаг 1: Подготовить XML файл

1. Файл `Форма_v2.xml` уже готов в папке интеграции

#### Шаг 2: Импортировать форму

1. В окне обработки в левой панели щелкните правой кнопкой по корню обработки
2. Выберите: **Добавить → Форма**
3. В окне создания формы:
   - **Имя:** `Форма`
   - **Синоним:** `Загрузка счетов из системы бюджетирования`
4. Нажмите **ОК**
5. Откройте созданную форму двойным кликом
6. В редакторе формы: **Файл → Загрузить из файла...**
7. Выберите файл `Форма_v2.xml`
8. Нажмите **Открыть**

### Метод 2: Создание формы вручную

Если импорт не работает, создайте форму вручную:

#### Шаг 1: Создать форму

1. В левой панели щелкните правой кнопкой по обработке
2. Выберите: **Добавить → Форма**
3. Имя: `Форма`

#### Шаг 2: Добавить реквизиты формы

В свойствах формы добавьте следующие реквизиты:

**Основные реквизиты:**
- `АдресAPI` - Строка(300)
- `APIToken` - Строка(500)
- `СписокСчетов` - ТаблицаЗначений с колонками:
  - `ИдентификаторСчета` - Число(10,0)
  - `НомерСчета` - Строка(50)
  - `ДатаСчета` - Дата
  - `ПоставщикНаименование` - Строка(500)
  - `ПоставщикИНН` - Строка(12)
  - `Сумма` - Число(15,2)
  - `СтатусВ1С` - Строка(50)
  - `ИдентификаторВ1С` - Строка(100)
- `ЛогОтладки` - Строка (неограниченная)

**Рабочие реквизиты:**
- `ТекущийИдентификаторСчета` - Число(10,0)
- `ТекущийСчетДанные` - ХранилищеЗначения
- `СозданныйИдентификаторДокумента` - Строка(100)

#### Шаг 3: Разместить элементы на форме

1. **Группа "Настройки подключения":**
   - Добавьте поле `АдресAPI` (заголовок: "Адрес API")
   - Добавьте поле `APIToken` (заголовок: "API Token")

2. **Панель кнопок:**
   - Кнопка "Получить список счетов" → команда `ПолучитьСписокСчетовДляОтображения`
   - Кнопка "Создать документ в 1С" → команда `СоздатьДокументВ1С`
   - Кнопка "Отметить в системе" → команда `ОтметитьСозданиеВСистеме`
   - Кнопка "Обработать все автоматически" → команда `ОбработатьВсеСчетаАвтоматически`

3. **Таблица счетов:**
   - Добавьте элемент **Таблица** для реквизита `СписокСчетов`
   - Высота: 15-20 строк

4. **Поле лога:**
   - Добавьте **ПолеТекстовогоДокумента** для реквизита `ЛогОтладки`
   - Заголовок: "Лог отладки и ошибок"
   - Только для чтения: Да
   - Высота: 10 строк

#### Шаг 4: Создать команды формы

В свойствах формы на вкладке **Команды** создайте:

1. **Команда:** `ПолучитьСписокСчетов`
   - **Действие:** `ПолучитьСписокСчетовДляОтображения`
   - **Заголовок:** "Получить список счетов"

2. **Команда:** `СоздатьДокумент`
   - **Действие:** `СоздатьДокументВ1С`
   - **Заголовок:** "Создать документ в 1С"

3. **Команда:** `ОтметитьВСистеме`
   - **Действие:** `ОтметитьСозданиеВСистеме`
   - **Заголовок:** "Отметить в системе"

4. **Команда:** `ОбработатьВсе`
   - **Действие:** `ОбработатьВсеСчетаАвтоматически`
   - **Заголовок:** "Обработать все автоматически"

### Шаг 5: Сохранить и загрузить

1. Сохраните все изменения: **Ctrl+S**
2. Закройте Конфигуратор
3. Запустите 1С в обычном режиме

---

## Настройка и тестирование

### Шаг 1: Открыть обработку

1. В 1С откройте: **Файл → Открыть**
2. Выберите сохраненный файл `ОбработкаСчетовИзAPI.epf`
3. Откроется форма обработки

### Шаг 2: Заполнить настройки подключения

**Пример настроек:**
- **Адрес API:** `http://93.189.228.52:8000/api/v1` (или ваш адрес)
- **API Token:** `tk_1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t` (ваш токен)

**Примечание:** Департамент определяется автоматически по API токену - не нужно указывать ID отдела

### Шаг 3: Тестирование подключения

#### Тест 1: Получение списка счетов

1. Нажмите кнопку **"Получить список счетов"**
2. В таблице должны появиться счета из системы
3. В логе должно быть: `"[HH:MM:SS] Получено счетов: N"`

**Если ошибка:**
- Проверьте адрес API (должен быть доступен из вашей сети)
- Проверьте токен (должен быть активен и иметь права)

#### Тест 2: Выбор и просмотр счета

1. В таблице выберите любой счет (щелкните по строке)
2. В логе появится детальная информация о счете:
   - Номер и дата счета
   - Данные поставщика (ИНН, КПП, банк)
   - Данные покупателя
   - Суммы (без НДС, НДС, итого)
   - Позиции счета

#### Тест 3: Создание документа

1. Выберите счет в таблице
2. Нажмите **"Создать документ в 1С"**
3. **ВАЖНО:** Функция `СоздатьДокументВ1СИзДанных()` - это **шаблон**
4. Вам нужно **доработать** эту функцию под вашу конфигурацию 1С:
   - Создать нужный документ (ПоступлениеТоваровУслуг, СчетНаОплату, и т.д.)
   - Заполнить реквизиты из `ДанныеСчета`
   - Провести документ (если требуется)
   - Вернуть строковый идентификатор созданного документа

**Пример доработки для типовой конфигурации:**

```bsl
Функция СоздатьДокументВ1СИзДанных(ДанныеСчета)

	// Создаем документ "Счет на оплату поставщика"
	НовыйДокумент = Документы.СчетНаОплатуПоставщика.СоздатьДокумент();

	// Заполняем шапку
	НовыйДокумент.Дата = ДанныеСчета.invoice_date;
	НовыйДокумент.Номер = ДанныеСчета.invoice_number;

	// Находим или создаем контрагента
	Контрагент = НайтиИлиСоздатьКонтрагента(ДанныеСчета.supplier);
	НовыйДокумент.Контрагент = Контрагент;

	// Заполняем табличную часть из items
	Если ДанныеСчета.Свойство("items") Тогда
		Для Каждого Позиция Из ДанныеСчета.items Цикл
			НоваяСтрока = НовыйДокумент.Товары.Добавить();
			НоваяСтрока.Номенклатура = НайтиИлиСоздатьНоменклатуру(Позиция.description);
			НоваяСтрока.Количество = Позиция.quantity;
			НоваяСтрока.Цена = Позиция.price;
			НоваяСтрока.Сумма = Позиция.amount;
		КонецЦикла;
	КонецЕсли;

	// Записываем документ
	Попытка
		НовыйДокумент.Записать(РежимЗаписиДокумента.Проведение);
		ДобавитьВЛог("✓ Документ создан: " + НовыйДокумент.Ссылка);
		Возврат Строка(НовыйДокумент.Ссылка.УникальныйИдентификатор());
	Исключение
		ДобавитьВЛог("✗ Ошибка записи документа: " + ОписаниеОшибки(), Истина);
		Возврат "";
	КонецПопытки;

КонецФункции
```

#### Тест 4: Отметка в системе

1. После успешного создания документа нажмите **"Отметить в системе"**
2. Счет будет отмечен в системе бюджетирования как обработанный
3. В столбце "ID в 1С" появится идентификатор созданного документа
4. Дата создания будет сохранена

---

## Автоматический режим работы

### Обработка всех счетов одной кнопкой

1. Заполните настройки подключения
2. **Доработайте** функцию `СоздатьДокументВ1СИзДанных()` под вашу конфигурацию
3. Нажмите **"Обработать все автоматически"**

**Что произойдет:**
1. Получение списка необработанных счетов
2. Для каждого счета:
   - Загрузка полных данных
   - Создание документа в 1С
   - Отметка в системе бюджетирования
3. В логе будет детальная информация о процессе

**Использование в регламентных заданиях:**

Вы можете настроить автоматический запуск обработки по расписанию:

```bsl
Процедура РегламентноеЗаданиеЗагрузкиСчетов()

	Обработка = ВнешниеОбработки.Создать("ОбработкаСчетовИзAPI");
	Обработка.АдресAPI = "http://93.189.228.52:8000/api/v1";
	Обработка.APIToken = "your_token_here";

	Обработка.ОбработатьВсеСчетаАвтоматически();

КонецПроцедуры
```

---

## Устранение неполадок

### Ошибка "Не удалось установить соединение"

**Возможные причины:**
- Неверный адрес API
- API недоступен из вашей сети
- Проблемы с интернет-соединением

**Решение:**
1. Проверьте адрес API в браузере
2. Убедитесь, что API доступен: `http://93.189.228.52:8000/docs`
3. Проверьте настройки прокси-сервера (если используется)

### Ошибка "401 Unauthorized"

**Причина:** Неверный или истекший API токен

**Решение:**
1. Проверьте правильность токена (без пробелов и переносов строк)
2. Убедитесь, что токен не был отозван в системе
3. Создайте новый токен и обновите настройки

### Ошибка "403 Forbidden"

**Причина:** Недостаточные права доступа у токена

**Решение:**
1. Проверьте scope токена (должен быть WRITE или FULL_ACCESS)
2. Создайте новый токен с правильными правами

### Счета не загружаются

**Возможные причины:**
- Нет обработанных счетов для департамента, привязанного к API токену
- Все счета уже созданы в 1С
- API токен привязан к другому департаменту

**Решение:**
1. Проверьте, к какому департаменту привязан ваш API токен в системе бюджетирования
2. Убедитесь, что есть счета со статусом "PROCESSED" для этого департамента
3. Проверьте фильтр `only_not_created_in_1c` в коде

### Ошибка создания документа

**Причина:** Ошибка в функции `СоздатьДокументВ1СИзДанных()`

**Решение:**
1. Проверьте лог отладки - там будет описание ошибки
2. Убедитесь, что функция правильно адаптирована под вашу конфигурацию
3. Проверьте наличие всех необходимых справочников (Контрагенты, Номенклатура)

---

## Дополнительная информация

### Структура данных счета

Каждый счет содержит следующие данные:

```json
{
  "invoice_id": 123,
  "invoice_number": "2635",
  "invoice_date": "2025-10-31",
  "supplier": {
    "name": "ООО ТРАСТ ТЕЛЕКОМ",
    "inn": "7734640247",
    "kpp": "504701001",
    "bank_name": "ПАО Сбербанк г. Москва",
    "bik": "044525225",
    "account": "40702810540000031808",
    "corr_account": "30101810400000000225"
  },
  "buyer": {
    "name": "ООО ДЕМО ГРУПП",
    "inn": "7806623324",
    "kpp": "780601001"
  },
  "total_amount": 2000.00,
  "amount_without_vat": 2000.00,
  "vat_amount": 0,
  "payment_purpose": "Оплата по счету №2635 от 31.10.2025",
  "contract_number": "t205150",
  "contract_date": "2025-04-01",
  "department_id": 1,
  "department_name": "IT отдел",
  "category_id": 5,
  "category_name": "Связь и интернет",
  "items": [
    {
      "description": "Услуги связи за Октябрь 2025 г.",
      "quantity": 1,
      "unit": "шт",
      "price": 2000.00,
      "amount": 2000.00
    }
  ]
}
```

### API Endpoints

Обработка использует следующие API endpoints:

1. **GET /external/invoices/pending** - Получение списка счетов
2. **GET /external/invoices/{id}** - Получение детальной информации
3. **POST /external/invoices/{id}/mark-created-in-1c** - Отметка создания

### Безопасность

- Храните API токен в защищенном месте
- Не передавайте токен третьим лицам
- Регулярно обновляйте токены (рекомендуется раз в 3-6 месяцев)
- При компрометации немедленно отзовите токен в системе

### Поддержка

При возникновении проблем обратитесь к администратору системы бюджетирования или в техническую поддержку.

---

**Версия документа:** 2.0
**Дата обновления:** 2025-11-05
**Автор:** IT Budget System Integration Team
