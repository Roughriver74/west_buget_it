# Отчет об импорте данных бюджета на 2025 год

## Дата импорта
24 октября 2025, 10:41

## Источник данных
**Файл:** `Планфакт2025.xlsx`
- **Лист 1 (План):** Плановые показатели бюджета по месяцам
- **Лист 2 (Факт):** Фактические расходы по месяцам

## Результаты импорта

### ✅ Успешно импортировано

#### Бюджетные категории
- **Создано новых категорий:** 29
- **Автоматическая классификация:** CAPEX/OPEX на основе ключевых слов
- **Примеры категорий:**
  - OPEX: Аутсорс, Битрикс 24, Связь, Интернет
  - CAPEX: Техника, Оборудование, Серверы

#### Записи плана бюджета
- **Всего записей:** 229
- **Год:** 2025
- **Период:** Январь - Декабрь
- **Статус:** APPROVED
- **Примеры плановых сумм:**
  - Аутсорс (январь): 25,000 руб
  - Битрикс 24 настройка (январь): 25,000 руб
  - Покупка ПО (январь): 160,000 руб

#### Фактические расходы (заявки)
- **Всего заявок:** 170
- **Номера заявок:** IMP-2025-{месяц}-{категория}
- **Статус:** PAID (оплачено)
- **Флаги:** is_paid=true, is_closed=true
- **Контрагент:** "Импорт из Excel"
- **Организация:** "ВЕСТ ООО"
- **Инициатор:** "Система"

### Структура импортированных данных

#### Маппинг месяцев
```python
MONTH_MAPPING = {
    'январь': 1, 'февраль': 2, 'март': 3, 'апрель': 4,
    'май': 5, 'Май': 5, 'июнь': 6, 'июль': 7, 'август': 8,
    'сентябрь': 9, 'октябрь': 10, 'ноябрь': 11, 'декабрь': 12
}
```

#### Логика классификации CAPEX/OPEX
```python
expense_type = ExpenseTypeEnum.CAPEX if any(word in name.lower() for word in [
    'техника', 'сервер', 'покупка', 'реновация', 'обновление'
]) else ExpenseTypeEnum.OPEX
```

#### Формат номеров заявок
- **Шаблон:** `IMP-{год}-{месяц:02d}-{category_id:03d}`
- **Пример:** `IMP-2025-12-043`

#### Даты в заявках
- **Дата заявки:** 15-е число месяца
- **Дата оплаты:** 28-е число месяца

## Проверка импортированных данных

### Общая статистика (Dashboard API)
```json
{
  "totals": {
    "planned": 30,510,000 руб,
    "actual": 19,944,242.27 руб,
    "remaining": 10,565,757.73 руб,
    "execution_percent": 65.37%
  },
  "capex_vs_opex": {
    "capex": 7,131,099 руб (35.76%),
    "opex": 12,813,143.27 руб (64.24%)
  }
}
```

### Топ категорий по расходам
1. **Аутсорс (OPEX):** 3,140,370 руб
2. **Связь (телефон/интернет) (OPEX):** 2,278,189.01 руб
3. **Техника (CAPEX):** 1,992,873 руб
4. **Битрикс 24 Разработка (OPEX):** 1,328,500 руб
5. **Непредвиденные расходы (OPEX):** 1,187,810 руб

### Распределение по статусам
- **PAID:** 262 заявки на 19,174,822.27 руб
- **PENDING:** 12 заявок на 740,420 руб
- **REJECTED:** 3 заявки на 29,000 руб

### Всего заявок в системе
- **Общее количество:** 277 (170 импортированных + 107 ранее существовавших)

## Технические детали импорта

### Файл скрипта
`backend/scripts/import_plan_fact_2025.py`

### Основные функции

#### 1. get_or_create_category()
- Получает существующую или создает новую категорию
- Автоматически определяет тип (CAPEX/OPEX)
- Устанавливает статус is_active=True

#### 2. import_budget_plan()
- Читает лист 1 Excel файла
- Удаляет строки-итоги
- Создает/обновляет записи BudgetPlan для каждой категории и месяца
- Проверяет существующие записи перед созданием новых

#### 3. import_actual_expenses()
- Читает лист 2 Excel файла
- Удаляет строки-итоги и региональные разбивки (МСК, КРД)
- Создает заявки на расходы (Expense) для каждой категории и месяца
- Генерирует уникальные номера заявок

### Обработка дубликатов
- **План:** Обновление существующих записей по ключу (год, месяц, категория)
- **Факт:** Пропуск создания при наличии заявки с таким же номером

### Обработка данных
- **Пустые ячейки:** Игнорируются (pd.isna())
- **Нулевые суммы:** Пропускаются (amount <= 0)
- **Decimal precision:** Все суммы конвертируются через Decimal(str(amount))

## Проверка работоспособности

### ✅ Backend API (http://localhost:8000)
- `/api/v1/budget/overview/2025/1` - Работает
- `/api/v1/expenses/` - Возвращает 277 записей
- `/api/v1/categories/` - Показывает все категории
- `/api/v1/analytics/dashboard` - Агрегированная статистика работает

### ✅ Frontend (http://localhost:5173)
- Dev-сервер запущен (процесс 24122)
- TypeScript компиляция успешна
- Приложение доступно в браузере

### ✅ База данных
- Миграции применены
- Данные успешно загружены
- Enum types корректны (английские значения)

## Примеры импортированных записей

### План (Budget Plan)
```json
{
  "year": 2025,
  "month": 1,
  "category_id": 1,
  "planned_amount": 25000.00,
  "opex_planned": 25000.00,
  "capex_planned": 0.00,
  "status": "APPROVED"
}
```

### Факт (Expense)
```json
{
  "number": "IMP-2025-12-043",
  "category_id": 43,
  "contractor_id": 41,
  "organization_id": 1,
  "amount": 150000.00,
  "request_date": "2025-12-15",
  "payment_date": "2025-12-28",
  "status": "PAID",
  "is_paid": true,
  "is_closed": true,
  "comment": "Импорт из Планфакт2025.xlsx (декабрь 2025)",
  "requester": "Система"
}
```

## Команда для повторного импорта

```bash
cd /Users/evgenijsikunov/projects/west/west_buget_it/backend
python3 scripts/import_plan_fact_2025.py
```

⚠️ **Внимание:** При повторном импорте:
- План будет обновлен (существующие записи перезапишутся)
- Факт не продублируется (проверка по номеру заявки)

## Рекомендации

### Для разработки
1. ✅ Скрипт импорта сохранен и готов к повторному использованию
2. ✅ Данные на 2025 год полностью загружены
3. ✅ Все API endpoints работают корректно

### Для тестирования
1. Проверить отображение данных в UI
2. Проверить фильтрацию по месяцам
3. Проверить графики и аналитику
4. Проверить экспорт в Excel

### Для продакшена
1. Создать резервную копию БД перед импортом
2. Проверить валидацию данных в Excel перед импортом
3. Добавить логирование в скрипт импорта
4. Рассмотреть создание интерфейса для импорта в UI

## Заключение

✅ **Импорт данных выполнен успешно**

Все плановые и фактические данные на 2025 год из файла `Планфакт2025.xlsx` успешно загружены в систему IT Budget Manager.

**Статистика:**
- 29 категорий бюджета
- 229 записей плана
- 170 заявок на расходы
- 277 заявок всего в системе
- Покрытие: все 12 месяцев 2025 года

Система полностью работоспособна и готова к использованию для управления IT-бюджетом.
