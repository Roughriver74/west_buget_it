# üö® –°–†–û–ß–ù–û–ï –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ê–ô–¢–ê

## –°–∞–π—Ç –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è - –±—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –û–¢–ö–ê–¢ (—Å–∞–º–æ–µ –±—ã—Å—Ç—Ä–æ–µ - 2 –º–∏–Ω—É—Ç—ã)

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh root@93.189.228.52

# –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /path/to/your/project

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –æ—Ç–∫–∞—Ç–∞
chmod +x URGENT_ROLLBACK.sh
./URGENT_ROLLBACK.sh

# –í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é 1 (–û—Ç–∫–∞—Ç–∏—Ç—å –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–º–º–∏—Ç—É)
```

–≠—Ç–æ –≤–µ—Ä–Ω—ë—Ç –∫–æ–¥ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Ä–∞–±–æ—á—É—é –≤–µ—Ä—Å–∏—é –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç —Å–∞–π—Ç.

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å –ø—Ä–æ–±–ª–µ–º—É)

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh root@93.189.228.52
cd /path/to/your/project

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker-compose -f docker-compose.prod.yml ps

# –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ backend (–∏—â–∏—Ç–µ –æ—à–∏–±–∫–∏)
docker-compose -f docker-compose.prod.yml logs backend --tail=100

# –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ frontend
docker-compose -f docker-compose.prod.yml logs frontend --tail=50
```

**–ò—â–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö:**
- ‚ùå `ModuleNotFoundError` - –ø—Ä–æ–±–ª–µ–º–∞ —Å –∏–º–ø–æ—Ä—Ç–∞–º–∏ Python
- ‚ùå `SyntaxError` - –æ—à–∏–±–∫–∞ –≤ –∫–æ–¥–µ
- ‚ùå `Exception` - –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- ‚ùå `unhealthy` - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –ø—Ä–æ—à—ë–ª healthcheck

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: –†–£–ß–ù–û–ô –û–¢–ö–ê–¢ (–µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

```bash
ssh root@93.189.228.52
cd /path/to/your/project

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–º–∏—Ç—ã
git log --oneline -5

# –û—Ç–∫–∞—Ç–∏—Ç—å—Å—è –Ω–∞ –æ–¥–∏–Ω –∫–æ–º–º–∏—Ç –Ω–∞–∑–∞–¥ (–¥–æ –º–æ–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π)
git reset --hard HEAD~1

# –ò–ª–∏ –æ—Ç–∫–∞—Ç–∏—Ç—å—Å—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–º–º–∏—Ç
git reset --hard 533080f  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ö–µ—à —Ä–∞–±–æ—á–µ–≥–æ –∫–æ–º–º–∏—Ç–∞

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å backend
docker-compose -f docker-compose.prod.yml down backend

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –±–µ–∑ –∫–µ—à–∞
docker-compose -f docker-compose.prod.yml build --no-cache backend

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–Ω–æ–≤–æ
docker-compose -f docker-compose.prod.yml up -d backend

# –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–ø—É—Å–∫–∞ (1-2 –º–∏–Ω—É—Ç—ã)
sleep 60

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
docker-compose -f docker-compose.prod.yml ps
docker-compose -f docker-compose.prod.yml logs backend --tail=30
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 4: –ë–´–°–¢–†–´–ô –ü–ï–†–ï–ó–ê–ü–£–°–ö (–µ—Å–ª–∏ –∫–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –Ω–æ —á—Ç–æ-—Ç–æ –∑–∞–≤–∏—Å–ª–æ)

```bash
ssh root@93.189.228.52
cd /path/to/your/project

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker-compose -f docker-compose.prod.yml restart

# –î–æ–∂–¥–∞—Ç—å—Å—è (30 —Å–µ–∫—É–Ω–¥)
sleep 30

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
docker-compose -f docker-compose.prod.yml ps
```

---

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã

### 1. –û—à–∏–±–∫–∞ –≤ Python –∫–æ–¥–µ (OptionsMiddleware)

**–°–∏–º–ø—Ç–æ–º—ã –≤ –ª–æ–≥–∞—Ö:**
```
SyntaxError: ...
ModuleNotFoundError: No module named '...'
AttributeError: ...
```

**–†–µ—à–µ–Ω–∏–µ:** –û—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–º–º–∏—Ç—É (–í–∞—Ä–∏–∞–Ω—Ç 1 –∏–ª–∏ 3)

### 2. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è

**–°–∏–º–ø—Ç–æ–º—ã:**
```bash
docker-compose ps
# Backend –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: Exited (1) –∏–ª–∏ unhealthy
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
docker-compose -f docker-compose.prod.yml logs backend --tail=200

# –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ë–î - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ë–î
docker-compose -f docker-compose.prod.yml restart db
sleep 10
docker-compose -f docker-compose.prod.yml restart backend
```

### 3. Traefik –Ω–µ –º–æ–∂–µ—Ç –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è –¥–æ backend

**–°–∏–º–ø—Ç–æ–º—ã:**
```bash
curl https://api.budget-west.shknv.ru/health
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 502 –∏–ª–∏ 503
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ backend –∑–∞–ø—É—â–µ–Ω
docker exec it_budget_backend_prod curl http://localhost:8000/health

# –ï—Å–ª–∏ –≤–Ω—É—Ç—Ä–∏ –æ—Ç–≤–µ—á–∞–µ—Ç - –ø—Ä–æ–±–ª–µ–º–∞ –≤ Traefik
docker restart traefik

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Traefik
docker logs traefik --tail=50
```

### 4. Frontend –Ω–µ –º–æ–∂–µ—Ç —Å–æ–±—Ä–∞—Ç—å—Å—è

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
docker-compose -f docker-compose.prod.yml logs frontend --tail=100
```

---

## –ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç:

```bash
# 1. –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å Up (healthy)
docker-compose -f docker-compose.prod.yml ps

# 2. API –æ—Ç–≤–µ—á–∞–µ—Ç
curl https://api.budget-west.shknv.ru/health
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: {"status":"healthy"}

# 3. Frontend –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
curl -I https://budget-west.shknv.ru
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: HTTP/2 200

# 4. –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
# https://budget-west.shknv.ru
```

---

## –ß—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ —Å –º–æ–∏–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏?

–Ø –¥–æ–±–∞–≤–∏–ª `OptionsMiddleware` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ CORS preflight –∑–∞–ø—Ä–æ—Å–æ–≤. –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞** - –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª `Response` –∏–ª–∏ `BaseHTTPMiddleware`
2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç middleware** - –Ω–æ–≤—ã–π middleware –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏
3. **–ü—Ä–æ–±–ª–µ–º–∞ —Å async** - –æ—à–∏–±–∫–∞ –≤ async/await –ª–æ–≥–∏–∫–µ
4. **–ü—Ä–æ–±–ª–µ–º–∞ —Å Gunicorn** - –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–æ–≤—ã–º middleware

---

## –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç

### –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å:

```bash
ssh root@93.189.228.52
cd /path/to/your/project

# –í–ù–ò–ú–ê–ù–ò–ï: —ç—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Å—Ç —Å –Ω—É–ª—è

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë
docker-compose -f docker-compose.prod.yml down

# 2. –û—Ç–∫–∞—Ç–∏—Ç—å –∫–æ–¥
git reset --hard 533080f  # –ü–æ—Å–ª–µ–¥–Ω–∏–π –†–ê–ë–û–ß–ò–ô –∫–æ–º–º–∏—Ç

# 3. –£–¥–∞–ª–∏—Ç—å –æ–±—Ä–∞–∑—ã
docker rmi it-budget-backend:prod it-budget-frontend:prod

# 4. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –≤—Å—ë –∑–∞–Ω–æ–≤–æ
docker-compose -f docker-compose.prod.yml build --no-cache

# 5. –ó–∞–ø—É—Å—Ç–∏—Ç—å
docker-compose -f docker-compose.prod.yml up -d

# 6. –ñ–¥–∞—Ç—å 2 –º–∏–Ω—É—Ç—ã
sleep 120

# 7. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
docker-compose -f docker-compose.prod.yml ps
docker-compose -f docker-compose.prod.yml logs
```

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Å—Ä–æ—á–Ω–æ–π –ø–æ–º–æ—â–∏

–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `./URGENT_ROLLBACK.sh` –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é 3
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ª–æ–≥–∏
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ:
   - –õ–æ–≥–∏ backend
   - –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (`docker-compose ps`)
   - –ß—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `curl https://api.budget-west.shknv.ru/health`

---

## –ü–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è - –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —Å–∞–π—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, —è —Å–æ–∑–¥–∞–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –∫–æ–¥–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π OPTIONS –∑–∞–ø—Ä–æ—Å–æ–≤.
