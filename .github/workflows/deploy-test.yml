name: Deploy to Test Server

on:
  push:
    branches:
      - test
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: test

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.TEST_SERVER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.TEST_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to test server
        env:
          SERVER_IP: ${{ secrets.TEST_SERVER_IP }}
          SERVER_USER: ${{ secrets.TEST_SERVER_USER }}
          PROJECT_PATH: ${{ secrets.TEST_SERVER_PROJECT_PATH }}
          GITHUB_REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ssh $SERVER_USER@$SERVER_IP "export PROJECT_PATH='$PROJECT_PATH'; export GITHUB_REPO='$GITHUB_REPO'; export GITHUB_TOKEN='$GITHUB_TOKEN'; bash -s" << 'ENDSSH'
            set -euo pipefail
            echo "üöÄ Starting deployment to test server..."
            echo "üìÅ Project path: $PROJECT_PATH"

            # Validate PROJECT_PATH is set
            if [ -z "$PROJECT_PATH" ]; then
              echo "‚ùå Error: PROJECT_PATH is not set!"
              exit 1
            fi

            # Ensure GitHub token is available for cloning/fetching
            if [ -z "${GITHUB_TOKEN:-}" ]; then
              echo "‚ùå Error: GITHUB_TOKEN is not available in the remote session"
              exit 1
            fi

            GIT_CLONE_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git"
            GIT_UPSTREAM_URL="https://github.com/${GITHUB_REPO}.git"

            # Navigate to project directory or create it
            if [ ! -d "$PROJECT_PATH" ]; then
              echo "üìÅ Creating project directory..."
              mkdir -p "$PROJECT_PATH"
            fi
            
            cd "$PROJECT_PATH" || exit 1

            # Check if git repository exists, if not - clone or initialize
            if [ ! -d .git ]; then
              echo "üì• Git repository not found. Checking if directory is empty..."
              if [ "$(ls -A 2>/dev/null)" ]; then
                echo "‚ö†Ô∏è  Directory is not empty. Initializing git repository..."
                git init
                git remote add origin "$GIT_CLONE_URL" 2>/dev/null || git remote set-url origin "$GIT_CLONE_URL"
                git fetch origin test
                git checkout -b test origin/test || git checkout test
              else
                echo "üì• Cloning repository..."
                git clone -b test "$GIT_CLONE_URL" .
              fi
              # Remove token from remote after successful clone/init
              git remote set-url origin "$GIT_UPSTREAM_URL"
            else
              # Ensure remote is set
              if ! git remote get-url origin &>/dev/null; then
                git remote add origin "$GIT_CLONE_URL"
              fi

              # Always use token URL for fetch to avoid auth issues on the server
              git remote set-url origin "$GIT_CLONE_URL"

              # Pull latest changes from test branch
              echo "üì• Pulling latest changes..."
              git fetch origin test || {
                echo "‚ö†Ô∏è  Failed to fetch, trying to set remote..."
                git remote set-url origin "$GIT_CLONE_URL"
                git fetch origin test
              }
              git reset --hard origin/test || git checkout -B test origin/test

              # Reset remote back to upstream URL without token
              git remote set-url origin "$GIT_UPSTREAM_URL"
            fi

            # Stop containers
            echo "üõë Stopping containers..."
            docker compose -f docker-compose.test.yml down || true

            # Rebuild and start containers
            echo "üî® Building and starting containers..."
            docker compose -f docker-compose.test.yml up -d --build

            # Wait for services to be healthy
            echo "‚è≥ Waiting for services to start..."
            sleep 30

            # Check service status
            echo "‚úÖ Checking service status..."
            docker compose -f docker-compose.test.yml ps

            # Test backend health
            echo "üè• Testing backend health..."
            curl -f http://localhost:8889/health || echo "‚ö†Ô∏è  Backend health check failed"

            echo "‚úÖ Deployment completed!"
          ENDSSH

      - name: Deployment status
        run: |
          echo "‚úÖ Deployment to test server completed successfully!"
          echo "üåê Frontend: http://${{ secrets.TEST_SERVER_IP }}:3002"
          echo "üîß Backend API: http://${{ secrets.TEST_SERVER_IP }}:8889"
          echo "üìö API Docs: http://${{ secrets.TEST_SERVER_IP }}:8889/docs"
