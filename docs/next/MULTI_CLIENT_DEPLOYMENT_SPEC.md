# IT Budget Manager — ТЗ на систему деплоя и управления клиентскими инсталляциями

Цель: создать воспроизводимую инфраструктуру, которая позволяет быстро устанавливать и обновлять IT Budget Manager на серверах клиентов (on-premise) с учётом индивидуальных настроек и лицензий.

## 1. Цели и задачи
- Стандартизировать процесс установки/обновления.
- Сократить время развёртывания нового клиента до нескольких часов.
- Исключить «ветки под клиента» — все кастомизации вынести в конфигурацию и лицензии.
- Обеспечить контроль версий, откаты, мониторинг и сбор диагностик.

## 2. Область действия
- Packaging (Docker образы, Helm/Compose).
- Конфигурационный репозиторий клиентов.
- CLI/оркестратор деплоя.
- CI/CD pipeline (GitHub Actions или аналог).
- Мониторинг и отчётность.

## 3. Target Architecture
```
┌──────────┐     ┌───────────────┐     ┌───────────────────┐
│ GitHub   │ --> │ Registry      │ --> │ Client Server     │
│ (source) │     │ (Docker/OCI)  │     │ (Docker/Helm)     │
└──────────┘     └───────────────┘     └───────────────────┘
       ^                  ^                     ^
       |                  |                     |
┌──────────────┐   ┌───────────────┐     ┌────────────────┐
│ Deploy Repo  │-->| CI/CD Pipeline|-->  │ budgetctl CLI  │
└──────────────┘   └───────────────┘     └────────────────┘
```
- Для каждого клиента существует файл конфигурации (values) с сетевыми и интеграционными настройками, а также списком модулей/лицензий.

## 4. Функциональные требования

### 4.1 Packaging
1. **Docker образы**
   - `backend`, `frontend`, `worker`, `scheduler`.
   - Build аргументы: `APP_VERSION`, `GIT_SHA`.
   - Сборка автоматизирована (CI) при каждом релизе.
2. **Helm chart / Docker Compose**
   - Хранение в отдельной директории `deploy/chart` или `deploy/compose`.
   - Поддержка кастомных ingress (HTTPS), внешнего PostgreSQL/Redis.
3. **Версионирование**
   - Теги вида `v1.4.0`.
   - Changelog в GitHub Releases.

### 4.2 Конфигурация клиентов
1. Репозиторий `deployments` (приватный).
2. Структура:
```
deployments/
  clients/
    acme.yaml
    beta.yaml
  environments/
    demo.yaml
  secrets/ (KMS/Vault references)
```
3. Каждая конфигурация описывает:
   - Домен, IP, SSH доступы.
   - Параметры БД/кэша.
   - Включённые модули, ограничения, ID лицензии.
   - Интеграции (1С, SSO, SMTP).
4. Конфигурации проходят схематическую валидацию (JSON Schema / Pydantic).

### 4.3 CLI/Оркестратор
- Инструмент `budgetctl` (Python/Go):
  - `budgetctl prepare --client acme` — проверка сервера (Docker, порты, ресурсы).
  - `budgetctl deploy --client acme --version v1.4.0` — скачивание образов, запуск Helm/Compose, миграции.
  - `budgetctl status --client acme` — сбор логов, health-check.
  - `budgetctl rollback --client acme --to v1.3.2`.
  - `budgetctl modules sync --client acme` — подтягивает активные модули из Лицензионного портала.
- CLI использует конфигурации из репозитория и Secrets из Vault.

### 4.4 CI/CD
- Pipeline (GitHub Actions/GitLab CI):
  1. Build & push Docker images.
  2. Запуск тестов.
  3. Публикация Helm chart/Compose пакета.
  4. Нотификация в Slack/Email о готовности релиза.
- Отдельный pipeline для репозитория `deployments`, который запускает `budgetctl` в режиме dry-run для проверки конфигураций.

### 4.5 Мониторинг и диагностика
- Скрипт устанавливвает агента (Prometheus Node Exporter, Loki/Vector для логов).
- Каждый клиентский инстанс отправляет heartbeat в Лицензионный портал (версия, uptime, активные модули).
- Набор runbook’ов: резервное копирование, восстановление, обновление сертификатов.

### 4.6 Документация
- Руководство по деплою (PDF/Markdown).
- Чек-листы для внедрения (preflight, post-deploy).
- Troubleshooting guide (типовые ошибки Docker/Helm/DB).

## 5. Нефункциональные требования
- **Надёжность**: возможность отката на предыдущую версию < 15 минут.
- **Безопасность**: конфигурации и секреты хранятся в шифрованном виде (Vault, SOPS). Доступ по ролям.
- **Масштабируемость**: поддержка 50+ клиентов, параллельные деплои (очередь задач).
- **Совместимость**: минимальные требования к серверам (CPU/RAM/Disk) документированы.

## 6. Процесс внедрения
1. Анализ текущих скриптов (docker-compose, run.sh) и определение целевой схемы.
2. Настройка CI для сборки образов и публикации chart/compose.
3. Создание репозитория конфигураций, разработка схемы валидации.
4. Реализация `budgetctl` (MVP: deploy, status).
5. Добавление интеграции с Лицензионным порталом (modules sync).
6. Документация + обучение команды внедрения.
7. Пилотное развёртывание на 1–2 клиентах, сбор обратной связи, отладка.

## 7. Артефакты
- Docker образы (backend/frontend/worker).
- Helm chart или комплект Compose файлов.
- CLI `budgetctl` + инструкции.
- Репозиторий `deployments` с шаблонами конфигураций.
- Документация: playbooks, runbooks, FAQ.

---
После реализации деплой становится управляемым процессом с единым инструментарием, что позволяет масштабировать продажи и поддерживать десятки клиентов без хаоса в ветках Git.
