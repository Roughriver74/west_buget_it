# Лицензионный портал IT Budget Manager — Техническое задание

Документ описывает требования к отдельному веб-порталу для управления лицензиями и модулями IT Budget Manager. Портал разрабатывается как самостоятельный сервис, интегрированный с продуктом посредством API и лицензированных токенов (см. `docs/MONETIZATION_MODULE_STRATEGY.md`).

## 1. Цели и задачи
- Централизовать контроль клиентов, ключей, модулей и сроков действия лицензий.
- Предоставить менеджерам продаж и внедрения инструменты для выпуска/отзыва ключей, отслеживания статуса установок и планирования апгрейдов.
- Обеспечить автоматическое взаимодействие с инсталляциями клиентов (call-home, валидация лицензий, уведомления).
- Поддержать процессы биллинга (привязка оплат, продлений) и аудит операций.

## 2. Пользовательские роли
| Роль               | Описание | Основные права |
|--------------------|----------|----------------|
| **Admin**          | Руководитель/DevOps | Полный доступ, управление пользователями портала, настройка интеграций, просмотр логов. |
| **Sales Manager**  | Продажи / аккаунт-менеджер | Создание клиентов, выпуск лицензий, просмотр оплат, запрос продлений. |
| **Implementation** | Инженер внедрения | Просмотр конфигураций, генерация активаций, мониторинг инсталляций, доступ к инструкциям. |
| **Support**        | Техподдержка | Просмотр клиентов, лицензий, статусов, создание тикетов/заметок, без права изменять ключи. |
| **Audit (read-only)** | Финансы/юристы | Только чтение: договора, история операций, отчётность. |

## 3. Основные сценарии
### 3.1 Управление клиентами
1. Создание карточки клиента: название юрлица, ИНН, сегмент, контактные лица, тип внедрения (on-prem / SaaS).
2. Привязка договоров: номер, дата, сумма, SLA.
3. Загрузка документов (договор, акт, ТЗ) и хранение ссылок на облако.

### 3.2 Управление лицензиями
1. Выбор клиента → «Создать лицензию».
2. Настройка параметров:
   - План (Базовый/Advanced/Enterprise).
   - Список модулей (AI Forecast, Multi-Department и т.д.).
   - Лимиты: кол-во пользователей, отделов, интеграций, API rate.
   - Срок действия (дата начала/окончания, период грейс-периода).
   - Технические параметры: домен установки, версия продукта, обязательные обновления.
3. Генерация лицензии:
   - Формирование JSON payload.
   - Подписание приватным ключом (ECDSA P-256).
   - Сохранение записи в БД + файла (JWT/zip).
4. Доставка ключа:
   - Скачивание файла менеджером.
   - Отправка на email клиента (через шаблон).
   - Публикация в защищённом клиентском кабинете (опционально).

### 3.3 Активации и мониторинг
1. Клиент загружает ключ в установку → backend вызывает API портала `/api/licenses/activate`.
2. Портал проверяет подпись, срок, статус оплаты и возвращает статус активации.
3. Запись об активации содержит: версия ПО, IP сервера, дата последней синхронизации, список активных модулей.
4. Портал показывает дашборд: сколько активных лицензий, просроченных, требующих продления.
5. Настройка уведомлений (email/Telegram/Slack) при истечении срока или нарушениях (например, превышение лимита пользователей).

### 3.4 Продления/апгрейды
1. Менеджер инициирует «Продлить» → вводит новые даты, стоимость, прикрепляет счёт.
2. После оплаты выпускается новый токен (версия+1) с расширенными условиями.
3. Клиент загружает новый ключ → установка автоматически активирует дополнительные модули.

### 3.5 Интеграция с биллингом / CRM
- REST/Webhook API для обмена статусами оплат (например, из 1С/CRM: «счёт оплачен» → лицензия доступна для выгрузки).
- Импорт/экспорт CSV/Excel по клиентам, лицензиям, оплатам.

## 4. Функциональные требования
### 4.1 UI
- SPA (React или аналог, Ant Design допустим для унификации UI).
- Главная панель: KPI (активные лицензии, истекающие, новые запросы).
- Список клиентов с фильтрами по сегменту, статусу, менеджеру.
- Карточка клиента: вкладки «Общее», «Лицензии», «Оплаты», «Контакты», «Документы», «Активности».
- Мастер создания лицензии с пошаговой валидацией.
- Просмотр/скачивание ключей, журнал версий.
- Раздел «Мониторинг» с таблицей активаций и статусами модулей.

### 4.2 Backend/API
- FastAPI (рекомендуется для унификации с основным продуктом).
- Аутентификация портала: JWT + RBAC, поддержка SSO (oAuth2) опционально.
- API для продукта:
  - `POST /api/licenses/activate` — регистрация активации, выдача конфигурации.
  - `GET /api/licenses/{license_key}` — получение статуса, списка модулей (используется установкой для периодической проверки).
  - `POST /api/licenses/heartbeat` — пинг от клиента (версия, модулей, ошибки).
  - `POST /api/licenses/revoke` — инициируется порталом, установка при получении отключает модули.
- API для CRM/интеграций:
  - `POST /api/external/payments` — обновление статуса оплаты.
  - `GET /api/external/licenses/export` — выгрузка данных для аналитики.

### 4.3 Безопасность
- Хранение приватного ключа лицензирования в Vault/Hardware Security Module (или как минимум в KMS).
- Все операции подписываются и аудитируются (кто, когда создал/изменил лицензии).
- Ролевое разграничение: только Admin может менять приватные ключи и настройки.
- Поддержка 2FA для пользователей портала.

### 4.4 Отчётность
- Таблицы/графики:
  - План-факт по продажам модулей.
  - Прогноз продлений (истекающие лицензии по месяцам).
  - Usage отчёты: какие модули используют чаще, какие простаивают.
- Экспорт PDF/Excel отчётов для руководства.

## 5. Нефункциональные требования
- **Надёжность**: SLA 99.5%, резервное копирование БД (ежедневно).
- **Масштабируемость**: минимум 1000 клиентов, 10 000 активных лицензий, до 100 активаций в сутки без деградации.
- **Безопасность**: соответствие требованиям обработки персональных данных (152-ФЗ); шифрование данных в покое (PostgreSQL TDE или уровень диска).
- **Локализация**: интерфейс на русском, с возможностью добавления английского.
- **Логи и аудит**: хранение не менее 365 дней, поддержка поиска по событиям.

## 6. Архитектура (высокий уровень)
```
[Portal Frontend] <---> [Portal API (FastAPI)]
                              |
                +-------------+-------------+
                |                           |
         [PostgreSQL DB]              [Message Broker/Queue]
                |                           |
        [License Storage]             [Notification Service]
                |
 [Key Management Service (подпись)]
```
- Продуктовые инсталляции клиентов обращаются к Portal API по защищённому каналу (VPN/HTTPS + client cert).
- Сообщения от установок (heartbeat) пишутся в очередь → обрабатываются worker’ами (обновляют статусы, создают алерты).

## 7. Модель данных (минимум)
- `clients`: информация о клиентах.
- `contracts`: договоры, ссылки, суммы.
- `licenses`: основной объект лицензии (id, client_id, продукты, модули, даты, лимиты, статус, ссылка на токен).
- `license_versions`: история изменений, подпись, checksum.
- `activations`: записи об установках (server_id, IP, версия, пользовательская БД, дата последнего heartbeat).
- `payments`: счета, статусы оплаты.
- `users` + `roles` + `audit_logs`.

## 8. Интеграционные точки
- **Основной продукт**: REST API для активации/валидации, обмен модулями/лимитами.
- **CRM (например, Битрикс/HubSpot)**: синхронизация клиентов и сделок, webhooks на оплату.
- **Биллинг (1С, банковские выписки)**: импорт платежей, автоматическое обновление статуса лицензий.
- **Системы уведомлений**: SMTP, Telegram bot, Slack webhook.

## 9. План реализации (оценочно)
| Этап | Содержание | Срок |
|------|------------|------|
| **E1: Аналитика** | Уточнение процессов продаж/поддержки, ER-диаграммы, прототип UI | 2 недели |
| **E2: Архитектура** | Схемы компонентов, выбор хранилища ключей, настройка CI/CD | 1 неделя |
| **E3: MVP (клиенты + лицензии)** | Базовый CRUD клиентов, выпуск лицензии, скачивание токена | 4 недели |
| **E4: Интеграция с продуктом** | API активации/heartbeat, журнал активаций | 3 недели |
| **E5: Продления и оплаты** | Учёт счетов, статусов оплат, уведомления | 3 недели |
| **E6: Мониторинг и отчёты** | Дашборды, аналитика модулей, экспорт | 3 недели |
| **E7: Безопасность и hardening** | RBAC, аудит, 2FA, KMS | 2 недели |
| **E8: Пилот** | Документация, обучение команды, пилот с 1-2 клиентами | 2 недели |

*(Сроки примерные, параллелизация возможна при наличии отдельных команд фронт/бек/DevOps.)*

## 10. Артефакты на выходе
- Репозиторий `license-portal` (frontend + backend).
- Инфраструктурные скрипты (Docker Compose, Helm chart).
- Документация:
  - Руководство пользователя портала.
  - API спецификация (OpenAPI).
  - Инструкции по интеграции с основным продуктом.
  - Политика безопасности и план восстановления.

---
После утверждения ТЗ можно переходить к детальному проектированию (UI макеты, ER-диаграммы, sequence diagrams) и запуску этапа E1.
