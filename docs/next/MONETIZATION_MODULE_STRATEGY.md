# IT Budget Manager — Монетизация, модульность и лицензирование

Документ резюмирует идеи из `docs/Манетизация BDR.xlsx`, описывает целевую модульную архитектуру, схему лицензирования и сценарии деплоя для разных клиентов. Используйте его как отправную точку для детальной проработки продукта и бизнес-процессов.

## 1. Вводные

- **Цель** — продавать IT Budget Manager как набор пакетов (Базовый / Advanced / Enterprise) с возможностью до продажи отдельных модулей.
- **Ограничение** — решение устанавливается на сервера клиентов (on-premise), поэтому необходим контроль лицензий и модулей без физического доступа к исходникам.
- **Рыночная позиция** — по сравнению с ИНТАЛЕВ / ИТАН вы выигрываете за счёт AI-прогнозирования и гибких модулей, западные конкуренты недоступны/дороги (`docs/Манетизация BDR.xlsx`, лист "Конкуренты").

## 2. Продуктовая модульность

| Блок                     | Описание                                                       | Базовая | Advanced | Enterprise | Цена отдельно¹ | Приоритет |
|--------------------------|----------------------------------------------------------------|:-------:|:--------:|:----------:|:--------------:|:---------:|
| **Ядро: Budget Core**    | План/факт, заявки, отчёты, 1 отдел, 3 версии бюджета          |   ✅    |    ✅    |     ✅     |      —         | Обязател. |
| **М1: AI Forecast**      | 4 метода прогнозирования, сценарии ML                         |   ❌    |    ✅    |     ✅     |   150 000 ₽    | Высокий   |
| **М2: Multi-Department** | Несколько департаментов, консолидация                         | 1 отдел |    ✅    |     ✅     |   100 000 ₽    | Средний   |
| **М3: Credit Portfolio** | Для банков: график, ставки, лимиты                            |   ❌    |    ❌    |     ✅     |   300 000 ₽    | Нишевый   |
| **М4: Advanced Integr.** | REST API, вебхуки, кастомные коннекторы                       |   ❌    |    ❌    |     ✅     |   200 000 ₽    | Высокий   |
| **М5: Analytics Plus**   | Расширенные дашборды, Pivot, экспорт в Power BI               |   ❌    |  Опция   |     ✅     |   120 000 ₽    | Средний   |
| **М6: Mobile App**       | iOS/Android approve/track                                     |   ❌    |  Опция   |   Опция    |   180 000 ₽    | Низкий    |
| **М7: Scenario Planning**| What-if моделирование, сравнение сценариев                    |   ❌    |  Опция   |     ✅     |   150 000 ₽    | Средний   |

¹ — см. лист "Начало", блок "Модульная структура продукта IT Budget Manager".

### Технические принципы
1. **Backend**: выделить `app/modules/<module_name>` (роуты, схемы, сервисы). Модули подключаются через FastAPI Dependency, проверяющий наличие лицензии в `organization_modules`.
2. **Frontend**: состояние организации содержит `enabledModules`. Роуты с модульной логикой грузятся лениво (`React.lazy`) и скрываются без доступа.
3. **БД**: таблицы `modules`, `licenses`, `organization_modules`, `license_activations`. Каждому модулю описываем фичи-флаги и зависимые лимиты (число пользователей, отделов, API-доступ).
4. **CI/CD**: каждый модуль — отдельный пакет (npm workspace / Python namespace). Это упрощает отключение/обновление и даёт прозрачный roadmap.

## 3. Лицензирование и управление доступом

### 3.1 Лицензионный портал
- FastAPI + React admin, доступен только команде.
- Хранит клиентов, контракты, активные лицензии, историю оплат и выданные ключи.
- Позволяет: выпустить лиценз. токен (JSON + подпись ECDSA), назначить срок, лимит пользователей, перечень модулей.

### 3.2 Жизненный цикл лицензии
1. **Создание**: менеджер формирует токен → отправляет клиенту (email / портал).
2. **Активация на стороне клиента**: CLI `budgetctl license apply license.jwt` или UI загрузки файла. Backend валидирует подпись, проверяет срок, записывает в `license_activations`.
3. **Проверка**: middleware сверяет токен при старте и каждые N часов. При истечении срока сервис уведомляет администратора клиента + ваш портал.
4. **Апгрейд / модуль**: выпускается новый токен с расширенным списком модулей. Клиент загружает — backend автоматически включает нужные фичи.
5. **Отзыв**: в портале помечаете лицензию отозванной → backend при следующей синхронизации блокирует модули.

### 3.3 Защита
- Нет прямых переключателей на фронтенде: всё решается на backend.
- Токен привязывается к `organization_id` + домен/URL сервера (опционально).
- Для offline-install вводим grace-period (например, 14 дней) + требование переактивации при продлении.

## 4. Стратегия деплоя для множества клиентов

| Компонент         | Подход                                                                                                     |
|-------------------|-------------------------------------------------------------------------------------------------------------|
| **Версии**        | Семантические релизы (`v1.3.0`). GitHub Releases с changelog. Клиенты получают фиксированный тег.           |
| **Конфигурация**  | Частный репозиторий `deployments` с `values/<client>.yaml` (URL БД, VPN, включённые модули).                |
| **Установка**     | Скрипт/CLI `budgetctl deploy --client acme --version v1.3.0` → подтягивает Docker-образы, применяет конфиг. |
| **Обновления**    | Ansible/Helm pipeline, который читает `client.yaml`, останавливает сервисы, накатывает миграции, запускает. |
| **Мониторинг**    | Лёгкий агент шлёт в портал: версия, активные модули, статус лицензии, ошибки.                              |
| **Демо/SaaS**     | Отдельный multi-tenant стенд (SaaS) для быстрого тест-драйва и абонентской модели.                          |

## 5. Оценка сложности

| Направление                 | Основные задачи                                                                                   | Сложность | Комментарии |
|----------------------------|----------------------------------------------------------------------------------------------------|-----------|-------------|
| **Архитектура модулей**    | Рефакторинг backend, feature flags, ограничение API, lazy loading фронта                           | Высокая   | Нужен чёткий реестр фич + тесты на отключение. |
| **Лицензионный портал**    | Токены, подпись, хранилище, UI для менеджеров                                                      | Средняя   | Можно начать с простого CRUD + JWT. |
| **Деплой для клиентов**    | CI/CD, packaging, скрипт установки, документация                                                   | Средняя   | Основная сложность в поддержке множества окружений. |
| **Бизнес-процессы**        | прайсинг, SLA, поддержка, апгрейды                                                                | Средняя   | Требуется тесная связь с продажами. |
| **Безопасность и контроль**| Неподписанные модули, защита от копирования, аудит                                                 | Высокая   | Возможно, потребуются аппаратные ключи/обфускация для особо чувствительных клиентов. |

Суммарно проект лежит на границе **средней/высокой** сложности: потребуется координация backend, frontend, DevOps и бизнес-команды. Реалистичный горизонт — 3‑4 месяца до первого коммерческого релиза при команде 3‑4 инженера + продакт.

## 6. Пошаговый план внедрения

### Фаза 0 — Подготовка (2 недели)
1. Утвердить список модулей, тарифов, SLA и границы ядра.
2. Описать матрицу прав доступа/лимитов (пользователи, отделы, интеграции).
3. Принять технические стандарты (структура модулей, формат лицензии, ключи подписи).

### Фаза 1 — Техническая модульность (4–5 недель)
1. Рефакторинг backend в отдельные пакеты, внедрение `modules` таблицы и middleware.
2. Добавление `enabledModules` на фронт, скрытие маршрутов и lazy-loading.
3. Написание тестов на включение/отключение каждого модуля, миграции данных.

### Фаза 2 — Лицензирование (3–4 недели)
1. Разработка портала: CRUD клиентов, генерация токена, журнал операций.
2. CLI/админка для загрузки лицензии на стороне клиента, API в backend.
3. Проверка токенов при старте, уведомления об истечении, отчёты.

### Фаза 3 — Деплой и операции (3–4 недели)
1. Упаковка сервиса в Docker-образы + версионирование.
2. Скрипт `budgetctl deploy`, репозиторий с конфигами клиентов, документация.
3. Набор playbooks/Helm-чарт для установки на сервера клиентов (поддержка VPN, SSL, резервное копирование).

### Фаза 4 — Готовность к продажам (2 недели)
1. Создание шаблонов договоров, SLA, прайс-листов, презентаций.
2. Настройка мониторинга агентов и отладка процесса апгрейда модулей.
3. Тренировка команды внедрения: сценарии STARTER/GROWTH/SCALE + Enterprise пилот.

### Постоянные активности
- Roadmap новых модулей и апгрейдов.
- Регулярные ревью цен/скидок (таблицы "Early Adopter", "Unit Economics").
- Сбор обратной связи от клиентов для корректировки пакетов.

## 7. Что изучить дальше

1. **`docs/Манетизация BDR.xlsx`** — уточнить расчёты по ROI модулей и план продаж.
2. **`docs/BUSINESS_OPERATION_MAPPING_UI.md`** — пример детальной UI-спецификации; по аналогии задокументировать каждый модуль.
3. **`README.md` + `DEPLOYMENT_QUICK_START.md`** — актуализировать инструкции под новую модель деплоя.

---
Если нужны дополнительные диаграммы (архитектура, поток лицензии, CI/CD) или шаблоны документов для отдела продаж, зафиксируйте требования и можно добавить разделы в этот файл.

