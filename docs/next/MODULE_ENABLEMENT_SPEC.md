# IT Budget Manager — ТЗ на модульную архитектуру и управление функциями

Документ описывает требования к доработке существующего решения с целью превратить его в модульную платформу, где каждая платная функция (AI Forecast, Multi-Department и т.д.) может быть включена или отключена на уровне лицензии.

## 1. Цели
- Отделить «Ядро» от надстроек, обеспечить независимое развитие модулей.
- Разрешить включать/отключать модули без пересборки кода и вмешательства в базу данных клиента.
- Гарантировать, что пользователь не сможет получить доступ к неоплаченным функциям (контроль на backend + UI).
- Создать основу для дальнейшей монетизации и расширения продуктовой линейки.

## 2. Область действия
- Backend (FastAPI, SQLAlchemy, Alembic).
- Frontend (React, React Router, React Query).
- База данных (PostgreSQL).
- Dev tooling (CI/CD, тесты, документация).

## 3. Требования к архитектуре

### 3.1 Backend
1. **Структура каталогов**
   - В `backend/app/` создать директорию `modules/`.
   - Каждый модуль — пакет с собственной `router.py`, `schemas.py`, `service.py`, задачами фоновых воркеров (если есть).
   - Ядро остается в `app/core` (заявки, бюджеты, справочники).
2. **Регистрация модулей**
   - Таблица `modules` (id, code, name, description, version, dependencies, is_active).
   - Таблица `organization_modules` (`organization_id`, `module_id`, `enabled_at`, `expires_at`, `limits` JSONB).
   - Таблица `feature_limits` для количественных ограничений (пользователи, отделы, интеграции).
3. **Feature Flag Middleware**
   - Middleware/Dependency `require_module("AI_FORECAST")`.
   - Вызов проверяет:
     - наличие записи в `organization_modules`;
     - срок действия;
     - дополнительные ограничения (например, cap по пользователям).
   - При отсутствии доступа возвращается `403 MODULE_NOT_ENABLED`.
4. **Событийная модель**
   - Сервис `ModuleService` отправляет события `module_enabled`, `module_disabled`, `limit_exceeded`.
   - Хранить события в `module_events` (для аудита + отладки).
5. **Тестирование**
   - Для каждого модуля — набор unit/integ тестов «включено/выключено».
   - Smoke-тесты на основные user journeys (например, создание заявки → аналитика) с отключёнными модулями.

### 3.2 Frontend
1. **State Management**
   - После логина API возвращает `enabledModules` и `limits`.
   - Состояние хранится в React Query `useOrganizationModules`.
2. **Route Guards**
   - Маршруты, страницы, кнопки, которые относятся к модулю, оборачиваются в `ModuleGate` компонент.
   - Недоступные модули не рендерятся, ссылки скрываются.
3. **Lazy Loading**
   - Тяжёлые разделы (AI дашборды, мобильные настройки) грузить через `React.lazy`, чтобы не отдавать код клиентам без доступа.
4. **UI Feedback**
   - Если пользователь переходит по прямой ссылке на недоступный модуль, показывать страницу «Модуль недоступен. Обратитесь к администратору».
5. **Telemetry**
   - Репортить включённые модули (для аналитики) через `ModuleUsage` API.

### 3.3 База данных
- Alembic миграции для `modules`, `organization_modules`, `feature_limits`, `module_events`.
- Добавить уникальные индексы (`organization_id + module_id`).
- Хранимые процедуры/триггеры не требуются, вся логика на приложении.

### 3.4 CI/CD и кодовая база
- ESLint/Pytest должны запускаться отдельно для каждого модуля (опция: matrix в GitHub Actions).
- Добавить `MODULES.md` с описанием зависимостей и гайдлайнами по добавлению нового модуля.
- В `README` объяснить механизм feature flags и как включать модуль на dev-окружении.

## 4. API изменения
| Endpoint                        | Действие |
|---------------------------------|----------|
| `GET /api/v1/organizations/me` | добавить поля `enabled_modules`, `module_limits`. |
| `GET /api/v1/modules`          | список доступных модулей (для UI и админки). |
| `POST /api/v1/modules/{code}/enable` | (админ) включение модуля организации (используется порталом лицензий). |
| `POST /api/v1/modules/usage`   | telemetry от фронтенда. |

## 5. Нефункциональные требования
- Нагрузка: система должна обслуживать до 50 одновременных организаций на одном инстансе без деградации при включении/выключении модулей.
- Безопасность: проверка модулей всегда происходит на backend; нельзя подменить фронтенд состояние.
- Обратная совместимость: существующие клиенты автоматически получают `Budget Core` (запись в `organization_modules`).

## 6. План внедрения (кратко)
1. Анализ текущей кодовой базы, каталог функций, сопоставление с модулями.
2. Подготовка схем БД, миграции, сиды модулей.
3. Рефакторинг backend (вынос модулей, внедрение middleware).
4. Обновление фронтенда (state, guards, lazy routes).
5. Тестирование, обновление документации.

## 7. Артефакты на выходе
- Обновлённые репозитории `backend`, `frontend` с модульной структурой.
- Alembic миграции, seed-скрипты для модулей.
- Тестовые сценарии «module on/off».
- Документация `MODULES.md`, обновлённый `README`.

--- 
После завершения работ система готова к интеграции с Лицензионным порталом и дальнейшей продаже отдельных модулей.
