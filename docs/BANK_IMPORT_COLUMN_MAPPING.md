# Интерактивное сопоставление колонок при импорте банковских выписок

## Обзор

Добавлен двухшаговый процесс импорта банковских транзакций с интерактивным сопоставлением колонок. Это решает проблему когда система не может автоматически определить колонки в Excel файле.

## Как это работает

### Шаг 1: Выбор файла и preview
1. Пользователь загружает Excel файл через "Импорт из Excel"
2. Нажимает кнопку "Далее"
3. Система читает файл и показывает:
   - Все доступные колонки
   - Автоматически определенные сопоставления (если возможно)
   - Первые 3 строки данных для предпросмотра

### Шаг 2: Сопоставление колонок
1. Открывается модальное окно "Сопоставление колонок"
2. Пользователь видит таблицу с тремя колонками:
   - **Поле в системе** - название поля (обязательные отмечены красной меткой)
   - **Колонка в файле** - выпадающий список для выбора колонки из Excel
   - **Пример данных** - первые 3 значения из выбранной колонки
3. Система показывает статус:
   - ✅ Зеленый блок: "Готово к импорту" (все обязательные поля заполнены)
   - ⚠️ Желтый блок: "Не хватает обязательных полей" (нужно указать дату и сумму)
4. Внизу показан предпросмотр первых 3 строк всего файла

### Шаг 3: Импорт
1. После подтверждения сопоставления система импортирует данные
2. Показывается результат: импортировано, пропущено, ошибки

## Технические детали

### Backend (Python/FastAPI)

#### Новые endpoints:
- `POST /api/v1/bank-transactions/import/preview` - предпросмотр файла
- `POST /api/v1/bank-transactions/import?column_mapping={...}` - импорт с custom mapping

#### Методы BankTransactionImporter:
```python
def preview_import(file_content: bytes, filename: str) -> Dict:
    """
    Возвращает:
    - columns: список колонок
    - detected_mapping: автоопределенные сопоставления
    - sample_data: первые 5 строк
    - total_rows: общее количество строк
    - required_fields: описание обязательных полей
    """

def import_from_excel(
    file_content: bytes,
    filename: str,
    department_id: int,
    user_id: int,
    column_mapping: Optional[Dict[str, str]] = None  # NEW
):
    """
    Если column_mapping передан - использует его
    Иначе - пытается автоопределить
    """
```

### Frontend (React/TypeScript)

#### Новые компоненты:
- `ColumnMappingModal` - интерактивное модальное окно для сопоставления

#### API методы:
```typescript
bankTransactionsApi.previewImport(file: File): Promise<PreviewResult>
bankTransactionsApi.importFromExcel(
  file: File,
  departmentId?: number,
  columnMapping?: Record<string, string>
): Promise<ImportResult>
```

## Обязательные поля

- **date** (Дата операции) - ⚠️ ОБЯЗАТЕЛЬНО
- **amount** (Сумма) - ⚠️ ОБЯЗАТЕЛЬНО
- counterparty (Контрагент) - опционально
- inn (ИНН контрагента) - опционально
- payment_purpose (Назначение платежа) - опционально
- document_number (Номер документа) - опционально
- type (Тип операции: Дебет/Кредит) - опционально

## Автоопределение колонок

Система пытается автоматически найти колонки по ключевым словам:

### Дата
- дата, date, дата операции, transaction date

### Сумма
- сумма, amount, sum, значение

### Контрагент
- контрагент, counterparty, плательщик, получатель, payer, recipient

### ИНН
- инн, inn

### Назначение платежа
- назначение, purpose, описание, description, комментарий, comment

### Номер документа
- номер, number, документ, document

### Тип операции
- тип, type, дебет, debit, кредит, credit

## Пример использования

### 1. У вас есть файл со стандартными колонками
```
Дата операции | Сумма | Контрагент | ИНН | Назначение
2025-01-15    | 50000 | ООО Вест   | ... | Оплата за услуги
```
→ Система автоматически определит все колонки, можно сразу импортировать

### 2. У вас файл с нестандартными названиями
```
Date | Total | Company Name | Tax ID | Description
2025-01-15 | 50000 | ООО Вест | ... | Оплата за услуги
```
→ Система частично определит:
- Date → date ✅
- Total → amount ✅
- Company Name → НЕ определено (нужно выбрать вручную)
- Tax ID → НЕ определено (нужно выбрать вручную)
- Description → payment_purpose ✅

Пользователь вручную выбирает:
- Company Name → counterparty
- Tax ID → inn

### 3. У вас файл с совсем другими названиями
```
Когда | Рубли | Кому | Примечание
2025-01-15 | 50000 | ООО Вест | Оплата
```
→ Система НЕ определит автоматически
Пользователь выбирает вручную все поля:
- Когда → date
- Рубли → amount
- Кому → counterparty
- Примечание → payment_purpose

## Преимущества

✅ **Гибкость**: Работает с любым форматом Excel файла
✅ **Наглядность**: Видно примеры данных перед импортом
✅ **Безопасность**: Можно проверить перед импортом, что выбраны правильные колонки
✅ **Удобство**: Автоопределение для стандартных форматов
✅ **Интуитивность**: Визуальные подсказки (зеленый/желтый статус)

## Что изменилось

### До (старая версия)
- Импорт сразу после выбора файла
- Ошибка если система не может определить колонки
- Нет возможности проверить данные

### После (новая версия)
- Шаг 1: Preview файла
- Шаг 2: Сопоставление колонок (если нужно)
- Шаг 3: Импорт
- Можно исправить ошибки автоопределения
- Видно примеры данных перед импортом
