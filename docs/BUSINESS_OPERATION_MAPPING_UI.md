# Business Operation Mapping - UI Руководство

## Обзор

Визуальный интерфейс для управления маппингами хозяйственных операций из 1С на категории бюджета.

**Доступ**: ADMIN и MANAGER

**Путь**: `/business-operation-mappings`

**Меню**: Справочники → Маппинг операций

## Возможности UI

### 1. Просмотр маппингов

**Таблица с колонками:**
- **Хозяйственная операция** - Название операции из 1С (например: `ОплатаПоставщику`)
- **Категория бюджета** - Связанная категория (с типом OPEX/CAPEX)
- **Приоритет** - Приоритет применения (1-100, чем выше - тем раньше)
- **Уверенность** - Уровень уверенности AI (0-100%, цветной прогресс-бар)
- **Отдел** - К какому отделу относится маппинг
- **Примечания** - Дополнительная информация
- **Статус** - Активный/Неактивный
- **Действия** - Редактировать/Удалить

### 2. Фильтрация

**Доступные фильтры:**
- Поиск по названию операции
- Фильтр по статусу (Активные/Неактивные)
- Автоматическая фильтрация по выбранному отделу

### 3. Создание маппинга

**Кнопка**: "Создать маппинг"

**Форма создания:**

```
┌─────────────────────────────────────────┐
│ Хозяйственная операция *                │
│ [ОплатаПоставщику___________________]   │
│ ℹ️ Название операции из 1С              │
│                                         │
│ Категория бюджета *                     │
│ [Выберите категорию ▼_______________]   │
│ ℹ️ Категория для этой операции         │
│                                         │
│ Приоритет *                             │
│ [10_________________________________]   │
│ ℹ️ 1-100, выше = раньше применяется    │
│                                         │
│ Уверенность (%) *                       │
│ [═════════════○═══] 98%                 │
│ ℹ️ Уровень уверенности AI               │
│                                         │
│ Примечания                              │
│ [_________________________________]     │
│ [_________________________________]     │
│                                         │
│ Активный [●]                            │
│                                         │
│        [Отмена]  [Создать]             │
└─────────────────────────────────────────┘
```

**Поля:**
- **Хозяйственная операция** (обязательно, макс 100 символов)
- **Категория бюджета** (обязательно, выбор из списка с поиском)
- **Приоритет** (обязательно, 1-100, по умолчанию 10)
- **Уверенность** (обязательно, 0-100%, слайдер, по умолчанию 98%)
- **Примечания** (опционально, макс 500 символов)
- **Активный** (переключатель, по умолчанию включен)

### 4. Редактирование маппинга

**Кнопка**: Иконка карандаша в колонке "Действия"

**Форма редактирования:**
- Все поля, кроме "Хозяйственная операция" (нельзя изменить)
- Автозаполнение текущими значениями
- Кнопки: "Отмена" / "Сохранить"

### 5. Удаление маппинга

**Кнопка**: Иконка корзины в колонке "Действия"

**Подтверждение**: "Удалить маппинг? Это действие нельзя отменить"

### 6. Массовые операции

**Выбор записей**: Чекбоксы слева в таблице

**Доступные операции при выборе:**
- **Активировать** - Сделать выбранные маппинги активными
- **Деактивировать** - Деактивировать выбранные маппинги
- **Удалить** - Удалить выбранные маппинги (с подтверждением)

**Счётчик**: "Выбрано: N"

### 7. Статистика

**Карточки вверху страницы:**
- **Всего маппингов** - Общее количество
- **Активных** - Количество активных (зелёный цвет)
- **Неактивных** - Количество неактивных (серый цвет)
- **Выбрано** - Количество выбранных для массовых операций

### 8. Пагинация

- По умолчанию: 20 записей на страницу
- Настройка: 10, 20, 50, 100 записей
- Показ общего количества: "Всего: N"

## Примеры использования

### Пример 1: Создание нового маппинга

**Сценарий**: Нужно настроить автоматическое назначение категории "Закупки у поставщиков" для операции "ОплатаПоставщику"

**Шаги:**
1. Открыть страницу "Справочники → Маппинг операций"
2. Нажать "Создать маппинг"
3. Заполнить форму:
   - Хозяйственная операция: `ОплатаПоставщику`
   - Категория: `Закупки у поставщиков` (OPEX)
   - Приоритет: `90`
   - Уверенность: `95%`
   - Примечания: `Оплата товаров/услуг поставщику`
   - Активный: ✓
4. Нажать "Создать"

**Результат**: Маппинг создан, теперь все банковские транзакции с операцией "ОплатаПоставщику" будут автоматически относиться к категории "Закупки у поставщиков" с уверенностью 95%.

### Пример 2: Изменение приоритета

**Сценарий**: Есть два маппинга для похожих операций, нужно задать правильный приоритет

**Шаги:**
1. Найти маппинг "ОплатаПоставщику" в таблице
2. Нажать иконку редактирования (карандаш)
3. Изменить приоритет с 10 на 100
4. Нажать "Сохранить"

**Результат**: Этот маппинг будет применяться первым (самый высокий приоритет).

### Пример 3: Массовая деактивация старых маппингов

**Сценарий**: Нужно временно отключить несколько маппингов

**Шаги:**
1. Выбрать чекбоксы у нужных маппингов
2. Нажать кнопку "Деактивировать"
3. Подтвердить действие

**Результат**: Выбранные маппинги деактивированы, перестали использоваться в классификации.

### Пример 4: Поиск маппинга по операции

**Сценарий**: Найти маппинг для операции "Зарплата"

**Шаги:**
1. Ввести "Зарплата" в поле поиска
2. Нажать Enter

**Результат**: Показаны все маппинги, содержащие "Зарплата" в названии операции (например: "ВыплатаЗарплаты", "ВыплатаЗарплатыПоЗарплатномуПроекту").

## Интеграция с AI-классификатором

Маппинги используются в `TransactionClassifier` для автоматической категоризации банковских транзакций:

**Приоритет проверки:**
1. **Business Operation Mapping** (HIGHEST PRIORITY) ← ЭТО
2. Historical data (прошлые назначения)
3. Keyword matching
4. Counterparty matching

**Логика:**
```
IF transaction.business_operation EXISTS THEN
    mapping = find_mapping_by_operation(business_operation, department_id)
    IF mapping.confidence >= 0.9 THEN
        → AUTO-CATEGORIZE (status = CATEGORIZED)
    ELSE
        → SUGGEST (status = NEEDS_REVIEW)
    END IF
ELSE
    → USE other classification methods
END IF
```

## API эндпоинты

UI использует следующие API:

```
GET    /api/v1/business-operation-mappings/         # Список
GET    /api/v1/business-operation-mappings/{id}     # Один маппинг
POST   /api/v1/business-operation-mappings/         # Создать
PUT    /api/v1/business-operation-mappings/{id}     # Обновить
DELETE /api/v1/business-operation-mappings/{id}     # Удалить
POST   /api/v1/business-operation-mappings/bulk-activate     # Массовая активация
POST   /api/v1/business-operation-mappings/bulk-deactivate   # Массовая деактивация
POST   /api/v1/business-operation-mappings/bulk-delete       # Массовое удаление
```

## Валидация

**Frontend validation:**
- Обязательные поля
- Диапазоны значений (приоритет 1-100, уверенность 0-100%)
- Максимальная длина текста

**Backend validation:**
- Проверка существования категории
- Проверка дубликатов (operation + department + category)
- Права доступа (ADMIN/MANAGER only)
- Multi-tenancy (department_id)

## Ошибки и их решение

### "Категория не найдена"
**Причина**: Выбранная категория была удалена или деактивирована
**Решение**: Выберите другую категорию из списка

### "Дубликат маппинга"
**Причина**: Маппинг с такой же комбинацией (операция + отдел + категория) уже существует
**Решение**: Используйте существующий маппинг или измените параметры

### "Недостаточно прав"
**Причина**: У пользователя нет роли ADMIN или MANAGER
**Решение**: Обратитесь к администратору для получения прав

### "Не удалось загрузить категории"
**Причина**: Ошибка подключения к API или отдел не выбран
**Решение**: Убедитесь, что выбран отдел в переключателе отделов

## Лучшие практики

### 1. Настройка приоритетов

**Рекомендуемая схема:**
- **100** - Критические маппинги (зарплата, налоги)
- **90** - Основные операции (оплаты поставщикам, поступления от клиентов)
- **50-70** - Вспомогательные операции
- **10-30** - Редкие операции

### 2. Уровень уверенности

**Рекомендации:**
- **≥90%** - Автоматическое назначение (CATEGORIZED)
- **70-89%** - Предложение с проверкой (NEEDS_REVIEW)
- **<70%** - Низкая уверенность, требует ручной проверки

### 3. Именование операций

**Хорошие имена:**
- ✅ `ОплатаПоставщику`
- ✅ `ВыплатаЗарплаты`
- ✅ `ПеречислениеНДС`

**Плохие имена:**
- ❌ `Оплата` (слишком общее)
- ❌ `Платеж123` (непонятное назначение)
- ❌ `тест` (не информативное)

### 4. Документирование

Используйте поле "Примечания" для описания:
- Назначения маппинга
- Особенностей применения
- Дат создания/изменения
- Автора настройки

**Пример:**
```
"Используется для автоматической категоризации всех оплат поставщикам.
Создано: 2025-11-17, Автор: Финансовый менеджер"
```

### 5. Мониторинг

**Регулярно проверяйте:**
- Количество транзакций со статусом NEEDS_REVIEW
- Маппинги с низкой уверенностью
- Неиспользуемые маппинги (можно деактивировать)

## Технические детали

**Frontend компоненты:**
- `BusinessOperationMappingsPage.tsx` - Основная страница
- `BusinessOperationMappingFormModal.tsx` - Форма создания/редактирования

**API клиент:**
- `frontend/src/api/businessOperationMappings.ts`

**Типы TypeScript:**
- `frontend/src/types/businessOperationMapping.ts`

**Backend:**
- Endpoints: `backend/app/api/v1/business_operation_mappings.py`
- Schemas: `backend/app/schemas/business_operation_mapping.py`
- Service: `backend/app/services/business_operation_mapper.py`

**База данных:**
- Таблица: `business_operation_mappings`
- Миграция: `2025_11_17_1122-181275141cb7_add_business_operation_mappings_table`

## Дополнительные ресурсы

- [Техническая документация](BUSINESS_OPERATION_MAPPING.md)
- [API документация](http://localhost:8000/docs)
- [Общая архитектура](../CLAUDE.md)

## Поддержка

При возникновении проблем:
1. Проверьте логи браузера (F12 → Console)
2. Проверьте логи backend: `tail -f backend.log`
3. Проверьте права доступа пользователя
4. Убедитесь, что выбран отдел
