# OData Filter Fix - Date Range Problem

**–î–∞—Ç–∞:** 17 –Ω–æ—è–±—Ä—è 2025
**–ü—Ä–æ–±–ª–µ–º–∞:** –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑ 1–° –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∞ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–∞—Ç

---

## üêõ –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### –°–∏–º–ø—Ç–æ–º—ã
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å (17.11.2025) –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- Postman –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤ OData –µ—Å—Ç—å
- Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `total_fetched: 0` - –Ω–∏—á–µ–≥–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
- –¢–∞–±–ª–∏—Ü–∞ bank_transactions –æ—Å—Ç–∞—ë—Ç—Å—è –ø—É—Å—Ç–æ–π

### –õ–æ–≥–∏
```
2025-11-17 12:24:12 - Using OData filter: year(Date) eq 2025 and month(Date) eq 11
2025-11-17 12:24:21 - 1C import completed: {'total_fetched': 0, 'total_processed': 0}
```

---

## üîç –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

### –°—Ç–∞—Ä—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

**–®–∞–≥ 1:** OData –∑–∞–ø—Ä–æ—Å –∫ 1–°
```python
filter_str = f'year(Date) eq {date_from.year} and month(Date) eq {date_from.month}'
# –ü—Ä–∏–º–µ—Ä: year(Date) eq 2025 and month(Date) eq 11
```
- –≠—Ç–æ—Ç —Ñ–∏–ª—å—Ç—Ä –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç **–í–°–ï –¥–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞ –Ω–æ—è–±—Ä—å 2025**
- –° –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π `$top=100` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 100 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

**–®–∞–≥ 2:** –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (Python)
```python
if date_from and record_date < date_from:
    continue  # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
if date_to and record_date > date_to:
    continue  # –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ 17 –Ω–æ—è–±—Ä—è –Ω–µ –≤—Ö–æ–¥—è—Ç –≤ –ø–µ—Ä–≤—ã–µ 100 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –º–µ—Å—è—Ü–∞ - –æ–Ω–∏ –Ω–µ –ø–æ–ø–∞–¥—É—Ç –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç!

### –ü—Ä–∏–º–µ—Ä

–í –Ω–æ—è–±—Ä–µ 2025 –≤ 1–° –µ—Å—Ç—å 500 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
1. 01.11.2025 - –¥–æ–∫—É–º–µ–Ω—Ç #1
2. 02.11.2025 - –¥–æ–∫—É–º–µ–Ω—Ç #2
3. ...
100. 10.11.2025 - –¥–æ–∫—É–º–µ–Ω—Ç #100
...
250. 17.11.2025 - –¥–æ–∫—É–º–µ–Ω—Ç #250 ‚Üê **–ù—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–¥–µ—Å—å**
...
500. 30.11.2025 - –¥–æ–∫—É–º–µ–Ω—Ç #500

**–°—Ç–∞—Ä—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º:**
1. OData –≤–µ—Ä–Ω—É–ª –ø–µ—Ä–≤—ã–µ 100 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (1-100)
2. Python —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç: –Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∑–∞ 17.11
3. –†–µ–∑—É–ª—å—Ç–∞—Ç: `total_fetched: 0` ‚ùå

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –ù–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

**–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—á–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä OData:**
```python
filter_str = f"Date ge datetime'{date_from.isoformat()}T00:00:00' and Date le datetime'{date_to.isoformat()}T23:59:59'"
# –ü—Ä–∏–º–µ—Ä: Date ge datetime'2025-11-17T00:00:00' and Date le datetime'2025-11-17T23:59:59'
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –§–∏–ª—å—Ç—Ä –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è **–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ 1–°** (–¥–æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏)
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞ –Ω—É–∂–Ω—ã–π –¥–µ–Ω—å
- ‚úÖ –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –ù–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞—Ç

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

```bash
curl -s --user "odata.user:ak228Hu2hbs28" \
  "http://10.10.100.77/trade/odata/standard.odata/Document_–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ–ë–µ–∑–Ω–∞–ª–∏—á–Ω—ã—Ö–î–µ–Ω–µ–∂–Ω—ã—Ö–°—Ä–µ–¥—Å—Ç–≤?\$filter=Date%20ge%20datetime'2025-11-17T00:00:00'%20and%20Date%20le%20datetime'2025-11-17T23:59:59'&\$top=5&\$format=json"
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞ 17.11.2025 ‚úÖ

---

## üîß –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### –§–∞–π–ª: `backend/app/services/odata_1c_client.py`

**–î–æ (—Å—Ç—Ä–æ–∫–∏ 210-224):**
```python
if date_from and date_to:
    if date_from.year == date_to.year and date_from.month == date_to.month:
        filter_str = f'year(Date) eq {date_from.year} and month(Date) eq {date_from.month}'
        endpoint_with_params += f'&$filter={filter_str}'
    else:
        year_filter = date_from.year - 1
        endpoint_with_params += f'&$filter=year(Date) gt {year_filter}'
elif date_from:
    year_filter = date_from.year - 1
    endpoint_with_params += f'&$filter=year(Date) gt {year_filter}'
```

**–ü–æ—Å–ª–µ:**
```python
if date_from and date_to:
    # –¢–æ—á–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç (Date >= start AND Date <= end)
    filter_str = f"Date ge datetime'{date_from.isoformat()}T00:00:00' and Date le datetime'{date_to.isoformat()}T23:59:59'"
    endpoint_with_params += f'&$filter={filter_str}'
elif date_from:
    # –¢–æ–ª—å–∫–æ –Ω–∞—á–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞
    filter_str = f"Date ge datetime'{date_from.isoformat()}T00:00:00'"
    endpoint_with_params += f'&$filter={filter_str}'
elif date_to:
    # –¢–æ–ª—å–∫–æ –∫–æ–Ω–µ—á–Ω–∞—è –¥–∞—Ç–∞
    filter_str = f"Date le datetime'{date_to.isoformat()}T23:59:59'"
    endpoint_with_params += f'&$filter={filter_str}'
```

**–î–æ (—Å—Ç—Ä–æ–∫–∏ 239-259):**
```python
# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ (–¥–ª—è —Ç–æ—á–Ω–æ–π –¥–∞—Ç—ã)
if results and (date_from or date_to):
    filtered = []
    for r in results:
        date_str = r.get('Date', '')
        if not date_str or date_str == '0001-01-01T00:00:00':
            continue

        try:
            record_date = datetime.fromisoformat(date_str.replace('Z', '+00:00')).date()

            if date_from and record_date < date_from:
                continue
            if date_to and record_date > date_to:
                continue

            filtered.append(r)
        except (ValueError, AttributeError):
            continue

    results = filtered
```

**–ü–æ—Å–ª–µ:**
```python
# –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞—Ç (OData —Ñ–∏–ª—å—Ç—Ä —É–∂–µ –ø—Ä–∏–º–µ–Ω—ë–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
if results:
    results = [
        r for r in results
        if r.get('Date') and r.get('Date') != '0001-01-01T00:00:00'
    ]
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–æ –¥–ª—è –≤—Å–µ—Ö 4 —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:**
1. `get_bank_receipts()` - –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è
2. `get_bank_payments()` - –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è
3. `get_cash_receipts()` - –ü–ö–û (–ø—Ä–∏—Ö–æ–¥–Ω—ã–µ –∫–∞—Å—Å–æ–≤—ã–µ –æ—Ä–¥–µ—Ä–∞)
4. `get_cash_payments()` - –†–ö–û (—Ä–∞—Å—Ö–æ–¥–Ω—ã–µ –∫–∞—Å—Å–æ–≤—ã–µ –æ—Ä–¥–µ—Ä–∞)

---

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```
2025-11-17 12:24:12 - Using OData filter: year(Date) eq 2025 and month(Date) eq 11
2025-11-17 12:24:21 - 1C import completed: {'total_fetched': 0}
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
```
2025-11-17 12:30:00 - Using OData filter: Date ge datetime'2025-11-17T00:00:00' and Date le datetime'2025-11-17T23:59:59'
2025-11-17 12:30:05 - 1C import completed: {'total_fetched': 15, 'created': 15}
```

---

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É —Ñ–∏–ª—å—Ç—Ä–∞

1. **–û—Ç–∫—Ä—ã—Ç—å UI:** http://localhost:5173
2. **–ü–µ—Ä–µ–π—Ç–∏:** Bank Transactions ‚Üí "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å 1–°"
3. **–í—ã–±—Ä–∞—Ç—å:** –¢–µ–∫—É—â–∏–π –¥–µ–Ω—å (17.11.2025)
4. **–ù–∞–∂–∞—Ç—å:** "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å"
5. **–û–∂–∏–¥–∞—Ç—å:** –ú–æ–¥–∞–ª–∫–∞ –∑–∞–∫—Ä–æ–µ—Ç—Å—è —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
6. **–î–æ–∂–¥–∞—Ç—å—Å—è:** –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ (~5-10 —Å–µ–∫—É–Ω–¥)
7. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:** –¢–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è ‚úÖ

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ backend

```bash
tail -f backend/logs/app.log | grep -i "odata\|sync"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
Using OData filter: Date ge datetime'2025-11-17T00:00:00' and Date le datetime'2025-11-17T23:59:59'
Fetching bank receipts: date_from=2025-11-17, date_to=2025-11-17
Fetching bank payments: date_from=2025-11-17, date_to=2025-11-17
1C import completed: {'total_fetched': 15, 'created': 15, 'updated': 0}
```

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –î–æ (year/month —Ñ–∏–ª—å—Ç—Ä)
- **–ó–∞–ø—Ä–æ—Å:** –í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞ –º–µ—Å—è—Ü (–Ω–∞–ø—Ä–∏–º–µ—Ä, 500 –∑–∞–ø–∏—Å–µ–π)
- **–í–æ–∑–≤—Ä–∞—Ç:** –ü–µ—Ä–≤—ã–µ 100 –∏–∑-–∑–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
- **–ö–ª–∏–µ–Ω—Ç:** –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–æ—á–Ω–æ–π –¥–∞—Ç–µ
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å 0 –∑–∞–ø–∏—Å–µ–π –µ—Å–ª–∏ –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –≤ –ø–µ—Ä–≤—ã—Ö 100

### –ü–æ—Å–ª–µ (Date ge/le —Ñ–∏–ª—å—Ç—Ä)
- **–ó–∞–ø—Ä–æ—Å:** –¢–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞ –Ω—É–∂–Ω—ã–π –¥–µ–Ω—å
- **–í–æ–∑–≤—Ä–∞—Ç:** –ù–∞–ø—Ä–∏–º–µ—Ä, 15 –∑–∞–ø–∏—Å–µ–π
- **–ö–ª–∏–µ–Ω—Ç:** –¢–æ–ª—å–∫–æ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞—Ç (0001-01-01)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

**–í—ã–∏–≥—Ä—ã—à:**
- ‚ö° –ú–µ–Ω—å—à–µ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –ø–æ —Å–µ—Ç–∏
- ‚ö° –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ 1–° —Å–µ—Ä–≤–µ—Ä
- ‚ö° –ù–µ—Ç –ª–∏—à–Ω–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞:**
- ‚úÖ OData —Ñ–∏–ª—å—Ç—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—á–Ω—ã–µ –¥–∞—Ç—ã
- ‚úÖ –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞ –ª—é–±–æ–π –¥–µ–Ω—å –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –±–µ–∑ –ø—Ä–æ–±–ª–µ–º
- ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∞

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 17 –Ω–æ—è–±—Ä—è 2025
**–§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:** `backend/app/services/odata_1c_client.py`
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü—Ä–æ–π–¥–µ–Ω–æ ‚úÖ
