# Исправление доступа для роли USER

## Проблема
Пользователи с ролью **USER** получали ошибку 403 при попытке доступа к:
- Справочникам (категории, контрагенты, организации)
- ФОТ (планирование зарплаты, аналитика)
- Бюджетному планированию
- Планированию доходов

## Решение
Роль **USER** теперь имеет доступ ко **всем разделам приложения**, но видит **только данные своего отдела**.

### Обновленная логика ролей:

| Роль | Доступ к разделам | Фильтрация по отделам |
|------|-------------------|----------------------|
| **USER** | Все разделы | Только свой отдел (автоматически) |
| **MANAGER** | Все разделы | Может фильтровать по отделам |
| **ACCOUNTANT** | Справочники, НДФЛ | Может фильтровать по отделам |
| **ADMIN** | Все + управление | Может фильтровать по отделам |

### Что изменилось:

#### Frontend ([frontend/src/App.tsx](../frontend/src/App.tsx))
Добавлена роль `USER` в `requiredRoles` для следующих страниц:
- ✅ Справочники (категории, контрагенты, организации)
- ✅ Сотрудники
- ✅ ФОТ (планирование, факт, KPI, аналитика)
- ✅ Бюджетное планирование
- ✅ Планирование доходов
- ✅ Калькулятор НДФЛ

#### Backend (без изменений)
Backend уже поддерживал эту логику:
- API автоматически фильтрует данные по `department_id` для USER
- Функция `check_department_access()` проверяет права доступа

## Применение изменений

### На локальной машине:
```bash
git pull origin main
cd frontend
npm run build
```

### На сервере (после pull на Coolify):
Frontend автоматически пересоберётся при следующем деплое через Coolify.

**Или вручную:**
```bash
ssh root@93.189.228.52
cd /path/to/project
git pull origin main
cd frontend
npm install
npm run build
# Перезапустить frontend сервис
```

## Проверка

1. Войдите под пользователем с ролью **USER**
2. Проверьте доступ к разделам:
   - Справочники → Категории бюджета
   - Справочники → Контрагенты
   - ФОТ → Планирование ФОТ
   - Бюджет → Бюджетное планирование

3. Убедитесь, что отображаются **только данные вашего отдела**

## Дополнительная информация

- **Коммит:** `6338088`
- **Изменённые файлы:**
  - `frontend/src/App.tsx` - обновлены `requiredRoles`
  - `CLAUDE.md` - обновлена документация по ролям
  - Добавлены скрипты импорта данных склада

## FAQ

### Как изменить роль пользователя?
```sql
-- На сервере
docker exec it_budget_db psql -U budget_user -d it_budget_db -c \
  "UPDATE users SET role = 'MANAGER' WHERE username = 'имя_пользователя';"
```

### Какую роль выбрать?
- **USER** - для сотрудников отдела, которые работают только со своим отделом
- **MANAGER** - для руководителей, которым нужен доступ ко всем отделам
- **ACCOUNTANT** - для бухгалтеров (справочники + НДФЛ)
- **ADMIN** - для администраторов системы

### Пользователь всё ещё видит 403?
1. Проверьте, что frontend обновлён (перезагрузите страницу Ctrl+F5)
2. Проверьте консоль браузера (F12) на наличие ошибок
3. Проверьте роль пользователя в базе данных
4. Проверьте, что у пользователя установлен `department_id`
