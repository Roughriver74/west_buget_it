# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç –ö—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ –ü–æ—Ä—Ç—Ñ–µ–ª—è –∏–∑ 1–°

**–î–∞—Ç–∞**: 14 –Ω–æ—è–±—Ä—è 2025
**–°—Ç–∞—Ç—É—Å**: –ü–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é ‚úÖ

---

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è –∏–∑ 1–° —á–µ—Ä–µ–∑ FTP.

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏**:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å FTP —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ XLSX —Ñ–∞–π–ª–æ–≤ (–ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è, —Å–ø–∏—Å–∞–Ω–∏—è, —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞)
- ‚úÖ UPSERT –ª–æ–≥–∏–∫–∞ (–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
- ‚úÖ –ê–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π, —Å—á–µ—Ç–æ–≤, –¥–æ–≥–æ–≤–æ—Ä–æ–≤
- ‚úÖ Multi-tenancy –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- ‚úÖ Scheduled –∏–º–ø–æ—Ä—Ç (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 8:00 –ø–æ –ú–æ—Å–∫–≤–µ)
- ‚úÖ –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ API

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   FTP Server    ‚îÇ  floppisw.beget.tech
‚îÇ  (1–° –≤—ã–≥—Ä—É–∑–∫–∞)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚îÇ XLSX files
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FTPClient      ‚îÇ  –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
‚îÇ  (credit_       ‚îÇ  ‚Üí data/credit_portfolio/
‚îÇ   portfolio_    ‚îÇ
‚îÇ   ftp.py)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  XLSXParser     ‚îÇ  –ü–∞—Ä—Å–∏–Ω–≥ Excel
‚îÇ  (credit_       ‚îÇ  ‚Üí Python dicts
‚îÇ   portfolio_    ‚îÇ
‚îÇ   parser.py)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  DataImporter   ‚îÇ  UPSERT –≤ –ë–î
‚îÇ  (credit_       ‚îÇ  ‚Üí PostgreSQL
‚îÇ   portfolio_    ‚îÇ
‚îÇ   importer.py)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### Backend —Å–µ—Ä–≤–∏—Å—ã

**1. FTP –ö–ª–∏–µ–Ω—Ç**
`backend/app/services/credit_portfolio_ftp.py`
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ FTP —Å–µ—Ä–≤–µ—Ä—É
- –ó–∞–≥—Ä—É–∑–∫–∞ XLSX —Ñ–∞–π–ª–æ–≤
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `data/credit_portfolio/`

**2. XLSX –ü–∞—Ä—Å–µ—Ä**
`backend/app/services/credit_portfolio_parser.py`
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞ (–ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ/—Å–ø–∏—Å–∞–Ω–∏–µ/—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞)
- –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–ª–æ–Ω–æ–∫ –Ω–∞ –ø–æ–ª—è –º–æ–¥–µ–ª–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –¥–∞—Ç

**3. –ò–º–ø–æ—Ä—Ç–µ—Ä –¥–∞–Ω–Ω—ã—Ö**
`backend/app/services/credit_portfolio_importer.py`
- UPSERT –ª–æ–≥–∏–∫–∞ –¥–ª—è receipts, expenses, details
- –ê–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
- Multi-tenancy (department_id)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞

**4. Scheduler**
`backend/app/services/scheduler.py`
- APScheduler –¥–ª—è —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á
- Cron —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (8:00 AM Moscow time)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- Graceful shutdown

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### .env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

```env
# Credit Portfolio FTP
CREDIT_PORTFOLIO_FTP_HOST=floppisw.beget.tech
CREDIT_PORTFOLIO_FTP_USER=floppisw_fin
CREDIT_PORTFOLIO_FTP_PASSWORD=G!5zb1FiL8!d
CREDIT_PORTFOLIO_FTP_REMOTE_DIR=/
CREDIT_PORTFOLIO_FTP_LOCAL_DIR=data/credit_portfolio
```

**–§–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã**:
- ‚úÖ `backend/app/core/config.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ FTP
- ‚úÖ `backend/.env.example` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

---

## üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç

### Scheduler –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 8:00 –ø–æ –ú–æ—Å–∫–≤–µ (Europe/Moscow)

**–ü—Ä–æ—Ü–µ—Å—Å**:
1. –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö XLSX —Ñ–∞–π–ª–æ–≤ —Å FTP
2. –ò–º–ø–æ—Ä—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞ (department)
3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ `fin_import_logs`

**–§–∞–π–ª—ã**:
- `backend/app/services/scheduler.py` - scheduler
- `backend/app/main.py` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ startup/shutdown events

**–õ–æ–≥–∏**:
```bash
# –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
[Startup] Background scheduler started
[Startup] Scheduled jobs:
  - Import Credit Portfolio Data from FTP (ID: credit_portfolio_import, Next run: 2025-11-15 08:00:00+03:00)
```

---

## üéØ –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–º–ø–æ—Ä—Ç–∞

### API Endpoint

```bash
POST /api/v1/credit-portfolio/import/trigger
Authorization: Bearer <jwt_token>
Content-Type: application/json

{
  "department_id": 1  # Optional, defaults to current user's department
}
```

**–î–æ—Å—Ç—É–ø**: —Ç–æ–ª—å–∫–æ MANAGER, ADMIN, ACCOUNTANT

**–ü—Ä–∏–º–µ—Ä**:
```bash
curl -X POST "http://localhost:8000/api/v1/credit-portfolio/import/trigger" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"department_id": 1}'
```

**–û—Ç–≤–µ—Ç**:
```json
{
  "success": true,
  "message": "Import completed: 3/3 files imported",
  "files_processed": 3,
  "files_failed": 0,
  "total_files": 3,
  "department_id": 1
}
```

---

## üìä –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö

### FinReceipt (–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è)
```python
operation_id          # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –æ–ø–µ—Ä–∞—Ü–∏–∏ (1–°)
organization_id       # FK ‚Üí FinOrganization
bank_account_id       # FK ‚Üí FinBankAccount
contract_id           # FK ‚Üí FinContract
document_date         # –î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
payer                 # –ü–ª–∞—Ç–µ–ª—å—â–∏–∫
amount                # –°—É–º–º–∞
payment_purpose       # –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
department_id         # Multi-tenancy (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
```

### FinExpense (–°–ø–∏—Å–∞–Ω–∏—è)
```python
operation_id          # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –æ–ø–µ—Ä–∞—Ü–∏–∏ (1–°)
organization_id       # FK ‚Üí FinOrganization
bank_account_id       # FK ‚Üí FinBankAccount
contract_id           # FK ‚Üí FinContract
document_date         # –î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞
recipient             # –ü–æ–ª—É—á–∞—Ç–µ–ª—å
amount                # –°—É–º–º–∞
payment_purpose       # –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
department_id         # Multi-tenancy (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
```

### FinExpenseDetail (–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π)
```python
expense_operation_id  # FK ‚Üí FinExpense.operation_id
payment_type          # –¢–∏–ø –ø–ª–∞—Ç–µ–∂–∞ (—Ç–µ–ª–æ/–ø—Ä–æ—Ü–µ–Ω—Ç—ã)
payment_amount        # –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞
vat_amount            # –ù–î–°
department_id         # Multi-tenancy (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)
```

---

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
cd backend
source venv/bin/activate
pip install -r requirements.txt
```

**–ù–æ–≤–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å**: APScheduler==3.10.4 (–¥–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

### 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
cd backend
source venv/bin/activate

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –ë–î
docker-compose up -d db

# –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
DEBUG=True alembic revision --autogenerate -m "add credit portfolio tables"

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å
DEBUG=True alembic upgrade head
```

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∏—Å—Ç–µ–º—É

```bash
./run.sh
```

**Scheduler –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–õ–æ–≥–∏ startup**:
```
[Startup] Starting IT Budget Manager v0.5.0
[Startup] Background scheduler started
[Startup] Scheduled jobs:
  - Import Credit Portfolio Data from FTP (ID: credit_portfolio_import, Next run: 2025-11-15 08:00:00+03:00)
```

---

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞

### FinImportLog —Ç–∞–±–ª–∏—Ü–∞

–í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –ë–î:

```sql
SELECT
  source_file,
  table_name,
  rows_inserted,
  rows_updated,
  rows_failed,
  status,
  processing_time_seconds,
  import_date
FROM fin_import_logs
ORDER BY import_date DESC
LIMIT 10;
```

**API endpoint –¥–ª—è –ª–æ–≥–æ–≤**:
```bash
GET /api/v1/credit-portfolio/import-logs?department_id=1
```

---

## üé® Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –°—Ç—Ä–∞–Ω–∏—Ü—ã –∫—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ –ø–æ—Ä—Ç—Ñ–µ–ª—è

**–ú–µ–Ω—é**: –§–∏–Ω–∞–Ω—Å—ã ‚Üí –ö—Ä–µ–¥–∏—Ç–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å

1. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** (`/credit-portfolio`)
   - –°–≤–æ–¥–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è, —Å–ø–∏—Å–∞–Ω–∏—è, –±–∞–ª–∞–Ω—Å)
   - –ü–æ–º–µ—Å—è—á–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞
   - –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

2. **KPI –º–µ—Ç—Ä–∏–∫–∏** (`/credit-portfolio/kpi`)
   - –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø–æ–≥–∞—à–µ–Ω–∏—è
   - –î–æ–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤/—Ç–µ–ª–∞ –∫—Ä–µ–¥–∏—Ç–∞
   - –ê–∫—Ç–∏–≤–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ã

3. **–î–µ–Ω–µ–∂–Ω—ã–µ –ø–æ—Ç–æ–∫–∏** (`/credit-portfolio/cash-flow`)
   - –ì—Ä–∞—Ñ–∏–∫ –ø–æ–º–µ—Å—è—á–Ω–æ–π –¥–∏–Ω–∞–º–∏–∫–∏
   - –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
   - –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º

4. **–î–æ–≥–æ–≤–æ—Ä—ã** (`/credit-portfolio/contracts`)
   - –°–ø–∏—Å–æ–∫ –¥–æ–≥–æ–≤–æ—Ä–æ–≤
   - –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–í—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç** `useDepartment()` hook –¥–ª—è multi-tenancy.

---

## ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å FTP –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

```python
from app.services.credit_portfolio_ftp import download_credit_portfolio_files

# –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã
files = download_credit_portfolio_files()
print(f"Downloaded {len(files)} files: {files}")
```

### 2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—Å–µ—Ä

```python
from app.services.credit_portfolio_parser import CreditPortfolioParser

parser = CreditPortfolioParser()
file_type, records = parser.parse_file('data/credit_portfolio/postuplenie_2025.xlsx')

print(f"File type: {file_type}")
print(f"Records: {len(records)}")
```

### 3. –†—É—á–Ω–æ–π –∏–º–ø–æ—Ä—Ç

```bash
# –ß–µ—Ä–µ–∑ API
curl -X POST "http://localhost:8000/api/v1/credit-portfolio/import/trigger" \
  -H "Authorization: Bearer $TOKEN"
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å scheduler

```bash
# –í –ª–æ–≥–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
grep "credit_portfolio_import" backend.log
```

---

## üö® Troubleshooting

### FTP –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã**: "FTP connection failed"

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å credentials
echo $CREDIT_PORTFOLIO_FTP_HOST
echo $CREDIT_PORTFOLIO_FTP_USER

# –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
ftp floppisw.beget.tech
# User: floppisw_fin
# Password: G!5zb1FiL8!d
```

### –§–∞–π–ª—ã –Ω–µ –ø–∞—Ä—Å—è—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã**: "Cannot determine file type"

**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∏–º–µ–Ω–∞–º**:
- –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è: —Å–æ–¥–µ—Ä–∂–∏—Ç "postuplenie" –∏–ª–∏ "–ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ"
- –°–ø–∏—Å–∞–Ω–∏—è: —Å–æ–¥–µ—Ä–∂–∏—Ç "spisanie" –∏–ª–∏ "—Å–ø–∏—Å–∞–Ω–∏–µ"
- –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞: —Å–æ–¥–µ—Ä–∂–∏—Ç "rasshifrovka" –∏–ª–∏ "—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞"

### Scheduler –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–°–∏–º–ø—Ç–æ–º—ã**: "Failed to start scheduler"

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install APScheduler==3.10.4

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
tail -f backend.log | grep scheduler
```

### –ò–º–ø–æ—Ä—Ç –¥—É–±–ª–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ

**–ü—Ä–∏—á–∏–Ω–∞**: UPSERT —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ `(operation_id, department_id)`

**–†–µ—à–µ–Ω–∏–µ**: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `operation_id` —É–Ω–∏–∫–∞–ª–µ–Ω –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ—Ç–¥–µ–ª–∞.

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°—Ç–∞—Ç—É—Å scheduler

```bash
# –õ–æ–≥–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
[Startup] Background scheduler started
[Startup] Scheduled jobs:
  - Import Credit Portfolio Data from FTP (Next run: 2025-11-15 08:00:00+03:00)
```

### –ò–º–ø–æ—Ä—Ç –ª–æ–≥–∏

```bash
# –£—Å–ø–µ—à–Ω—ã–π –∏–º–ø–æ—Ä—Ç
[INFO] Starting scheduled credit portfolio import
[INFO] Downloaded 3 files from FTP
[INFO] Department –û–û–û –í–µ—Å—Ç: 3/3 files imported
[INFO] Scheduled import completed: 3 files imported, 0 failed

# –û—à–∏–±–∫–∞
[ERROR] Error during FTP import: Connection timeout
```

---

## üéâ –ò—Ç–æ–≥

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç –ö—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ –ü–æ—Ä—Ç—Ñ–µ–ª—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤!**

### ‚úÖ –ì–æ—Ç–æ–≤–æ:
1. FTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
2. XLSX –ø–∞—Ä—Å–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π 3 —Ç–∏–ø–æ–≤ —Ñ–∞–π–ª–æ–≤
3. –ò–º–ø–æ—Ä—Ç–µ—Ä —Å UPSERT –ª–æ–≥–∏–∫–æ–π –∏ multi-tenancy
4. Scheduler –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –≤ 8:00
5. API endpoint –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
6. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
7. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ main.py (startup/shutdown)
8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### üöÄ –ó–∞–ø—É—Å–∫:
```bash
./run.sh  # Scheduler –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
```

### üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏**: –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 8:00 –ø–æ –ú–æ—Å–∫–≤–µ
- **–í—Ä—É—á–Ω—É—é**: `POST /api/v1/credit-portfolio/import/trigger`

**–ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É!** üéä
