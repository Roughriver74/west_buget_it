# Руководство по импорту банковских транзакций

## Обзор

Модуль Bank Transactions поддерживает импорт данных из Excel файлов с **автоматическим определением колонок** и **AI-классификацией**.

**Поддерживаемые форматы**:
- ✅ Excel (.xlsx) - рекомендуется
- ⚠️ Excel Binary (.xlsb) - требует конвертации в .xlsx
- ⚠️ CSV (.csv) - частично поддерживается (требует явного указания кодировки)

---

## Быстрый старт

### Шаг 1: Подготовьте Excel файл

**Минимальные обязательные колонки**:
1. **Дата операции** (transaction_date)
2. **Сумма** (amount)
3. **Назначение платежа** (payment_purpose)

**Рекомендуемые дополнительные колонки**:
4. Контрагент (counterparty_name)
5. ИНН контрагента (counterparty_inn)
6. Тип операции (transaction_type): "Списание" или "Поступление"
7. Номер документа (document_number)

### Шаг 2: Импортируйте через API

```bash
curl -X POST "http://localhost:8000/api/v1/bank-transactions/import" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@bank_statement.xlsx" \
  -F "department_id=1" \
  -F "auto_classify=true" \
  -F "auto_match=true"
```

### Шаг 3: Проверьте результаты

```json
{
  "total_rows": 150,
  "imported": 148,
  "errors": 2,
  "auto_categorized": 120,
  "auto_matched": 85,
  "needs_review": 28,
  "error_details": [
    {
      "row": 15,
      "error": "Invalid date format"
    }
  ]
}
```

---

## Детальная инструкция

### 1. Подготовка Excel файла

#### Формат даты
**Поддерживаемые форматы**:
- `DD.MM.YYYY` (31.01.2025) - рекомендуется
- `YYYY-MM-DD` (2025-01-31)
- `DD/MM/YYYY` (31/01/2025)
- Excel date number (серийный номер Excel)

**Примеры**:
```
✅ Правильно:
31.01.2025
2025-01-31
01/31/2025

❌ Неправильно:
31 января 2025
январь 2025
2025
```

#### Формат суммы
**Поддерживаемые форматы**:
- Числа: `150000`, `150000.50`, `150 000,50`
- С разделителями: `150,000.50` (точка - десятичный разделитель)
- С валютой: `150000 руб.` (валюта игнорируется)

**Примеры**:
```
✅ Правильно:
150000
150000.50
150 000,50
-25000 (отрицательные для расходов)

❌ Неправильно:
сто пятьдесят тысяч
N/A
пусто
```

#### Типы операций
**Автоматическое определение**:
- "Списание", "Расход", "Дебет", "DEBIT" → DEBIT
- "Поступление", "Доход", "Кредит", "CREDIT" → CREDIT
- Если не указано: определяется по знаку суммы (отрицательные = DEBIT)

#### ИНН контрагента
**Формат**: 10 или 12 цифр
```
✅ Правильно:
7727563778 (10 цифр - юрлицо)
770400372264 (12 цифр - ИП)

⚠️ Допустимо:
77 27 56 37 78 (пробелы удаляются)
ИНН 7727563778 (префикс удаляется)

❌ Неправильно:
123 (слишком короткий)
abc123 (буквы)
```

---

### 2. Автоматическое определение колонок

Система автоматически определяет назначение колонок по заголовкам.

#### Поддерживаемые заголовки (case-insensitive)

**Дата операции**:
- "Дата операции", "Дата", "Date", "Transaction Date"
- "Дата проводки", "Posting Date"

**Сумма**:
- "Сумма", "Amount", "Sum", "Сумма операции"
- "Transaction Amount"

**Контрагент**:
- "Контрагент", "Counterparty", "Наименование"
- "Получатель", "Плательщик", "Payee", "Payer"

**ИНН контрагента**:
- "ИНН", "INN", "ИНН контрагента"
- "Counterparty INN"

**Назначение платежа**:
- "Назначение платежа", "Purpose", "Description"
- "Payment Purpose", "Описание", "Details"
- "Основание платежа"

**Тип операции**:
- "Тип операции", "Operation Type", "Transaction Type"
- "Дебет/Кредит", "Debit/Credit"

**Номер документа**:
- "Номер документа", "Document Number", "Doc No"
- "№ платежного поручения"

**Дата документа**:
- "Дата документа", "Document Date", "Doc Date"

**Наша организация**:
- "Организация", "Organization", "Наша организация"
- "Плательщик" (если это мы)

**Наш счет**:
- "Счет", "Account", "Номер счета", "Account Number"

#### Пример структуры Excel файла

| Дата операции | Контрагент | ИНН | Сумма | Назначение платежа | Тип операции |
|--------------|------------|-----|-------|-------------------|--------------|
| 15.01.2025 | ООО Яндекс | 7736207543 | -50000.00 | Оплата рекламы Яндекс.Директ | Списание |
| 20.01.2025 | ООО Офис Групп | 7727563778 | -150000.00 | Аренда офиса январь 2025 | Списание |
| 25.01.2025 | ПАО МТС | 7740000076 | -5000.00 | Услуги связи | Списание |

---

### 3. Параметры импорта

#### department_id (обязательный)
Отдел, к которому относятся транзакции.

```bash
-F "department_id=1"
```

**Получить список отделов**:
```bash
GET /api/v1/departments
```

#### auto_classify (optional, default: true)
Автоматическая AI-классификация транзакций.

```bash
-F "auto_classify=true"   # Включить
-F "auto_classify=false"  # Выключить (все транзакции в статусе NEW)
```

**Когда включить**:
- ✅ Для регулярных операций (аренда, связь, подписки)
- ✅ Когда есть подробное назначение платежа
- ✅ Для повторяющихся контрагентов

**Когда выключить**:
- ❌ Для нестандартных операций
- ❌ Когда назначение платежа неинформативное
- ❌ Для первого импорта (чтобы вручную проверить)

#### auto_match (optional, default: true)
Автоматическое связывание с заявками на расход.

```bash
-F "auto_match=true"   # Включить
-F "auto_match=false"  # Выключить
```

**Когда включить**:
- ✅ Если заявки на расход уже созданы в системе
- ✅ Для связывания оплат с заявками

**Когда выключить**:
- ❌ Если заявок еще нет
- ❌ Для доходных операций (CREDIT)

---

### 4. Процесс импорта (подробно)

#### Этап 1: Загрузка и валидация файла
```
1. Проверка формата файла (.xlsx, .xls, .xlsb*)
2. Чтение листа (первый лист или указанный)
3. Определение строки заголовков (обычно первая строка)
4. Маппинг колонок на поля модели
```

#### Этап 2: Парсинг данных
```
Для каждой строки:
1. Пропуск пустых строк
2. Парсинг даты (DD.MM.YYYY → date)
3. Парсинг суммы (строка → Decimal)
4. Парсинг типа операции (строка → DEBIT/CREDIT)
5. Очистка ИНН (удаление пробелов и префиксов)
6. Проверка обязательных полей
```

#### Этап 3: AI-классификация (если auto_classify=true)
```
Для каждой транзакции:
1. Проверка исторических данных (по ИНН)
   → Если найдено: категория с confidence 95%

2. Keyword matching в payment_purpose
   → Подсчет совпадений
   → Расчет confidence

3. Keyword matching в counterparty_name (fallback)
   → Confidence * 0.8

4. Назначение категории:
   - Confidence ≥ 90% → category_id заполняется, статус = CATEGORIZED
   - Confidence < 90% → suggested_category_id, статус = NEEDS_REVIEW
   - Confidence = 0 → статус = NEW
```

#### Этап 4: Smart-matching (если auto_match=true)
```
Для каждой транзакции:
1. Поиск подходящих заявок (Expenses) по:
   - department_id (обязательно)
   - counterparty_inn (если есть)
   - Дата ±30 дней
   - Сумма ±5%
   - Категория (если уже назначена)

2. Scoring algorithm (0-100):
   - ИНН совпадает: +40
   - Сумма точно: +30, ±1%: +25, ±5%: +20
   - Дата ±7 дней: +20, ±30 дней: +10
   - Категория совпадает: +10

3. Связывание:
   - Score ≥ 85 → expense_id заполняется, статус = MATCHED
   - Score < 85 → suggested_expense_id
```

#### Этап 5: Сохранение в БД
```
1. Создание записей BankTransaction
2. Заполнение полей:
   - import_source = "MANUAL_UPLOAD"
   - import_file_name = имя файла
   - imported_at = текущая дата/время
   - department_id = указанный
   - is_active = true

3. Обработка дубликатов:
   - Проверка по external_id_1c (если есть)
   - Пропуск существующих транзакций
```

#### Этап 6: Формирование отчета
```json
{
  "total_rows": 150,           // Всего строк в файле (без заголовка)
  "imported": 148,             // Успешно импортировано
  "skipped": 0,                // Пропущено (дубликаты)
  "errors": 2,                 // Ошибки
  "auto_categorized": 120,     // Автоматически категоризировано
  "auto_matched": 85,          // Автоматически связано с заявками
  "needs_review": 28,          // Требует ручной проверки
  "error_details": [
    {
      "row": 15,
      "error": "Invalid date format: '31 января 2025'",
      "data": { "Дата": "31 января 2025", ... }
    },
    {
      "row": 42,
      "error": "Missing required field: amount"
    }
  ]
}
```

---

### 5. Обработка после импорта

#### Проверка необработанных транзакций
```bash
# Получить транзакции требующие проверки
GET /api/v1/bank-transactions?only_unprocessed=true&department_id=1

# Результат: транзакции со статусом NEW или NEEDS_REVIEW
```

#### Массовая обработка

**1. Массовая категоризация**:
```bash
POST /api/v1/bank-transactions/bulk-categorize
{
  "transaction_ids": [1, 2, 3, 4, 5],
  "category_id": 15,
  "notes": "Все это аренда офиса"
}
```

**2. Массовое связывание**:
```bash
POST /api/v1/bank-transactions/bulk-link
{
  "transaction_ids": [10, 11, 12],
  "expense_id": 42
}
```

**3. Массовое утверждение**:
```bash
POST /api/v1/bank-transactions/bulk-status-update
{
  "transaction_ids": [1, 2, 3, 4, 5, 10, 11, 12],
  "status": "APPROVED"
}
```

---

### 6. Типичные проблемы и решения

#### Проблема 1: "Invalid date format"
**Причина**: Дата в неподдерживаемом формате
**Решение**:
- Использовать формат DD.MM.YYYY
- Или конвертировать колонку в Excel в формат даты

#### Проблема 2: "Missing required field: amount"
**Причина**: Колонка с суммой не найдена или содержит нечисловые значения
**Решение**:
- Проверить заголовок колонки (должен быть "Сумма" или "Amount")
- Убедиться что все значения числовые

#### Проблема 3: "Too many NEEDS_REVIEW"
**Причина**: AI не может определить категорию (низкая уверенность)
**Решение**:
- Добавить больше ключевых слов в TransactionClassifier
- Вручную категоризировать первые транзакции каждого контрагента
- Заполнить ИНН контрагентов (для исторических данных)

#### Проблема 4: "Duplicate transaction"
**Причина**: Транзакция уже существует (по external_id_1c)
**Решение**:
- Это нормально - дубликаты автоматически пропускаются
- Если нужно обновить: сначала удалить старую транзакцию

#### Проблема 5: "File too large"
**Причина**: Файл превышает лимит 10MB
**Решение**:
- Разбить файл на части (по месяцам)
- Или удалить лишние колонки (оставить только необходимые)

---

### 7. Конвертация файлов

#### Конвертация .xlsb в .xlsx

**Способ 1: Microsoft Excel**
```
1. Открыть файл .xlsb в Excel
2. Файл → Сохранить как
3. Выбрать формат "Excel Workbook (*.xlsx)"
4. Сохранить
```

**Способ 2: LibreOffice Calc**
```
1. Открыть файл .xlsb в LibreOffice Calc
2. Файл → Сохранить как
3. Выбрать формат "ODF Spreadsheet (.ods)" или "Excel 2007-365 (.xlsx)"
4. Сохранить
```

**Способ 3: Python (автоматизация)**
```python
import pyxlsb
import openpyxl

# Читать .xlsb
with pyxlsb.open_workbook('input.xlsb') as wb:
    with wb.get_sheet(1) as sheet:
        data = []
        for row in sheet.rows():
            data.append([cell.v for cell in row])

# Записать .xlsx
wb_new = openpyxl.Workbook()
ws = wb_new.active
for row in data:
    ws.append(row)
wb_new.save('output.xlsx')
```

---

### 8. Расширенные возможности

#### Импорт с кастомным маппингом колонок

Если заголовки в вашем файле не стандартные, можно указать маппинг вручную:

```python
# В будущих версиях
POST /api/v1/bank-transactions/import
{
  "file": <binary>,
  "department_id": 1,
  "column_mapping": {
    "Дата проводки": "transaction_date",
    "Сумма списания": "amount",
    "Наименование контрагента": "counterparty_name",
    "ИНН": "counterparty_inn",
    "Основание": "payment_purpose"
  }
}
```

#### Импорт из CSV

```bash
curl -X POST "http://localhost:8000/api/v1/bank-transactions/import" \
  -F "file=@bank_statement.csv" \
  -F "department_id=1" \
  -F "delimiter=;" \
  -F "encoding=windows-1251"
```

**Параметры**:
- `delimiter`: разделитель (`,` или `;` или `\t`)
- `encoding`: кодировка (`utf-8`, `windows-1251`, `cp1252`)

---

### 9. API Reference

#### POST /api/v1/bank-transactions/import

**Request**:
```
Content-Type: multipart/form-data

file: <binary Excel file>
department_id: integer (required)
auto_classify: boolean (optional, default: true)
auto_match: boolean (optional, default: true)
```

**Response 200 OK**:
```json
{
  "total_rows": 150,
  "imported": 148,
  "skipped": 0,
  "errors": 2,
  "auto_categorized": 120,
  "auto_matched": 85,
  "needs_review": 28,
  "error_details": [...]
}
```

**Response 400 Bad Request**:
```json
{
  "detail": "Invalid file format. Supported formats: .xlsx, .xls"
}
```

**Response 413 Payload Too Large**:
```json
{
  "detail": "File size exceeds limit of 10MB"
}
```

---

### 10. Примеры готовых файлов

#### Шаблон 1: Минимальный (3 колонки)
| Дата | Сумма | Назначение платежа |
|------|-------|--------------------|
| 15.01.2025 | -50000 | Оплата рекламы Яндекс.Директ |

#### Шаблон 2: Полный (все поля)
| Дата операции | Контрагент | ИНН | Сумма | Назначение платежа | Тип операции | Номер документа | Организация |
|--------------|------------|-----|-------|-------------------|--------------|----------------|-------------|
| 15.01.2025 | ООО Яндекс | 7736207543 | -50000.00 | Оплата рекламы | Списание | 123 | ООО Демо |

#### Шаблон 3: Банковская выписка (типичный)
| Дата проводки | Дебет | Кредит | Контрагент | ИНН контрагента | Назначение платежа | № платежного поручения |
|--------------|-------|--------|------------|-----------------|-------------------|----------------------|
| 15.01.2025 | 50000.00 | | ООО Яндекс | 7736207543 | Оплата рекламы Яндекс.Директ январь 2025 | 123 |
| 20.01.2025 | 150000.00 | | ООО Офис Групп | 7727563778 | Аренда офиса 100 кв.м Москва январь 2025 | 124 |
| 25.01.2025 | | 500000.00 | ООО Клиент | 7701234567 | Оплата по договору 25/2025 | 125 |

**Примечание**:
- Дебет = списание (DEBIT, отрицательная сумма)
- Кредит = поступление (CREDIT, положительная сумма)

---

### 11. Автоматизация импорта

#### Импорт по расписанию (cron)

**Скрипт**: `backend/scripts/import_bank_transactions_auto.py`

```python
#!/usr/bin/env python3
"""
Автоматический импорт банковских транзакций из директории
Запускать через cron: 0 9 * * * /path/to/script.py
"""

import os
import glob
from app.services.bank_transaction_import import BankTransactionImporter
from app.db import get_db

IMPORT_DIR = "/path/to/bank/statements/"
ARCHIVE_DIR = "/path/to/archive/"
DEPARTMENT_ID = 1

def import_files():
    db = next(get_db())
    importer = BankTransactionImporter(db, DEPARTMENT_ID, user_id=1)

    # Найти все .xlsx файлы
    files = glob.glob(os.path.join(IMPORT_DIR, "*.xlsx"))

    for file_path in files:
        print(f"Importing {file_path}...")

        with open(file_path, 'rb') as f:
            result = importer.import_from_excel(
                f.read(),
                auto_classify=True,
                auto_match=True
            )

        print(f"Imported: {result.imported}, Errors: {result.errors}")

        # Переместить в архив
        filename = os.path.basename(file_path)
        os.rename(file_path, os.path.join(ARCHIVE_DIR, filename))

if __name__ == "__main__":
    import_files()
```

**Настройка cron**:
```bash
# Импорт каждый день в 9:00
0 9 * * * cd /app/backend && python scripts/import_bank_transactions_auto.py >> /var/log/bank_import.log 2>&1
```

---

### 12. FAQ

**Q: Можно ли импортировать несколько файлов одновременно?**
A: Нет, импорт выполняется по одному файлу. Используйте скрипт автоматизации для массового импорта.

**Q: Что делать если транзакции импортировались дважды?**
A: Дубликаты автоматически пропускаются (по external_id_1c). Если нужно удалить - используйте DELETE API.

**Q: Можно ли импортировать транзакции за прошлые годы?**
A: Да, система поддерживает любые даты. Нет ограничений по периоду.

**Q: Как импортировать транзакции из 1С?**
A: Экспортируйте из 1С в Excel, затем импортируйте через API. Убедитесь что external_id_1c заполнен для предотвращения дубликатов.

**Q: Что делать с ошибками в error_details?**
A: Исправьте ошибки в Excel файле и повторите импорт. Успешно импортированные транзакции не будут дублироваться.

---

## Контакты и поддержка

При возникновении проблем:
1. Проверьте логи: `tail -f backend.log`
2. Проверьте формат файла (используйте шаблоны выше)
3. Обратитесь к администратору системы
