# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å—á–µ—Ç–æ–≤ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–∏–≤—è–∑–∫–∏ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å—á–µ—Ç–æ–≤ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–∞—Å—Ö–æ–¥ –≤ 1–° –∏–∑ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—á–µ—Ç–æ–≤ (invoices).

**–î–∞—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: 2025-11-20
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

---

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–∞—Å—Ö–æ–¥ –≤ 1–° —á–µ—Ä–µ–∑ OData API –ø–æ–ª–µ `–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π–°—á–µ—Ç–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞_Key` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–ª–æ—Å—å –∑–Ω–∞—á–µ–Ω–∏–µ–º `EMPTY_GUID` (00000000-0000-0000-0000-000000000000), —á—Ç–æ –æ–∑–Ω–∞—á–∞–ª–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–∞–Ω–∫–æ–≤—Å–∫–æ–º —Å—á–µ—Ç–µ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞.

–ü—Ä–∏ —ç—Ç–æ–º:
- –í –º–æ–¥–µ–ª–∏ `ProcessedInvoice` —É–∂–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –ø–æ–ª–µ `supplier_account` —Å –Ω–æ–º–µ—Ä–æ–º –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á–µ—Ç–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ (—Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ OCR + AI)
- –í 1–° –µ—Å—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ `Catalog_–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ–°—á–µ—Ç–∞–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤` —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å—á–µ—Ç–∞—Ö
- –ë–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—á–µ—Ç–∞ –≤ 1–° –ø—Ä–∏—Ö–æ–¥–∏–ª–æ—Å—å –≤—Ä—É—á–Ω—É—é –≤—ã–±–∏—Ä–∞—Ç—å —Å—á–µ—Ç –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞—è–≤–∫–∏

---

## –†–µ—à–µ–Ω–∏–µ

### 1. –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤ OData1CClient

–î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `get_bank_account_by_number_and_owner` –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á–µ—Ç–∞ –ø–æ –Ω–æ–º–µ—Ä—É –∏ –≤–ª–∞–¥–µ–ª—å—Ü—É:

```python
def get_bank_account_by_number_and_owner(
    self,
    account_number: str,
    owner_guid: str
) -> Optional[Dict[str, Any]]:
    """
    –ü–æ–ª—É—á–∏—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫–∏–π —Å—á–µ—Ç –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –ø–æ –Ω–æ–º–µ—Ä—É —Å—á–µ—Ç–∞ –∏ –≤–ª–∞–¥–µ–ª—å—Ü—É

    Args:
        account_number: –ù–æ–º–µ—Ä –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á–µ—Ç–∞ (20 —Ü–∏—Ñ—Ä)
        owner_guid: GUID –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Å—á–µ—Ç–∞ (–∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞)

    Returns:
        –î–∞–Ω–Ω—ã–µ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á–µ—Ç–∞ –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
    """
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**

- –û—á–∏—Å—Ç–∫–∞ –Ω–æ–º–µ—Ä–∞ —Å—á–µ—Ç–∞ –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤
- OData —Ñ–∏–ª—å—Ç—Ä –ø–æ –ø–æ–ª—é `–ù–æ–º–µ—Ä–°—á–µ—Ç–∞`
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤–ª–∞–¥–µ–ª—å—Ü—É –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (—Ç.–∫. $filter –ø–æ Owner –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ 1–°)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Owner –∫–∞–∫ —Å—Ç—Ä–æ–∫–∏ –∏ –∫–∞–∫ —Å–ª–æ–≤–∞—Ä—è (–≥–∏–±–∫–æ—Å—Ç—å –∫ —Ñ–æ—Ä–º–∞—Ç—É 1–°)
- –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —ç—Ç–∞–ø–æ–≤ –ø–æ–∏—Å–∫–∞
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π —Å—á–µ—Ç –∏–ª–∏ None

**–§–∞–π–ª**: `backend/app/services/odata_1c_client.py` (—Å—Ç—Ä–æ–∫–∏ 791-849)

### 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ InvoiceTo1CConverter

–û–±–Ω–æ–≤–ª–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–∞—Å—Ö–æ–¥:

```python
# –ü–æ–∏—Å–∫ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á–µ—Ç–∞ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
bank_account_guid = self.EMPTY_GUID
if invoice.supplier_account:
    logger.info(f"üè¶ Attempting to find bank account: {invoice.supplier_account}")
    try:
        bank_account_data = self.odata_client.get_bank_account_by_number_and_owner(
            account_number=invoice.supplier_account,
            owner_guid=validation_result.counterparty_guid
        )
        if bank_account_data:
            bank_account_guid = bank_account_data.get('Ref_Key')
            logger.info(f"‚úÖ Found bank account in 1C: {bank_account_data.get('Description')}")
        else:
            logger.warning(f"‚ö†Ô∏è Bank account not found in 1C, using EMPTY_GUID")
    except Exception as e:
        logger.error(f"‚ùå Error looking up bank account: {e}")
        bank_account_guid = self.EMPTY_GUID
```

**Workflow:**

1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è `invoice.supplier_account`
2. –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞ –ø–æ–∏—Å–∫–∞ —Å –Ω–æ–º–µ—Ä–æ–º —Å—á–µ—Ç–∞ –∏ GUID –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞
3. –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–∏—Å–∫–µ - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ Ref_Key
4. –ü—Ä–∏ –æ—à–∏–±–∫–µ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—á–µ—Ç–∞ - fallback –∫ EMPTY_GUID
5. –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

**–§–∞–π–ª**: `backend/app/services/invoice_to_1c_converter.py` (—Å—Ç—Ä–æ–∫–∏ 397-414)

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–æ–∑–¥–∞–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞:

#### test_bank_account_lookup.py

–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç —Å –¥–≤—É–º—è —Ç–µ—Å—Ç–∞–º–∏:

1. **–¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å—á–µ—Ç–∞**:
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ 1–°
   - –ù–æ–º–µ—Ä —Å—á–µ—Ç–∞: `40702810709270005397`
   - Owner GUID: `c069022c-6aa7-11e6-8d13-00155d006a03`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –ø–æ–∏—Å–∫ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö

2. **–¢–µ—Å—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å—á–µ—Ç–∞**:
   - –ü–æ–∏—Å–∫ —Å fake –¥–∞–Ω–Ω—ã–º–∏
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç None

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã**: ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ

#### find_counterparty_with_account.py

–£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ —Å –±–∞–Ω–∫–æ–≤—Å–∫–∏–º–∏ —Å—á–µ—Ç–∞–º–∏ –≤ 1–° –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö.

#### check_bank_account_format.py

–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å—á–µ—Ç–æ–≤.

#### check_bank_from_existing.py

–ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å—á–µ—Ç–æ–≤ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞—è–≤–∫–∞—Ö 1–°.

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á–µ—Ç–∞ –≤ 1–°

```json
{
  "Ref_Key": "f662f1a8-6aa7-11e6-8d13-00155d006a03",
  "Owner": "c069022c-6aa7-11e6-8d13-00155d006a03",
  "Owner_Type": "StandardODATA.Catalog_–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã",
  "Description": " \" –¢–æ—á–∫–∞\" –ü–ê–û\" –•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –±–∞–Ω–∫ –û—Ç–∫—Ä—ã—Ç–∏–µ\"   (–†–∞—Å—á–µ—Ç–Ω—ã–π)",
  "–ù–æ–º–µ—Ä–°—á–µ—Ç–∞": "40702810709270005397",
  "–ë–ò–ö–ë–∞–Ω–∫–∞": "",
  "–ó–∞–∫—Ä—ã—Ç": false,
  "–≤—Å_–û—Å–Ω–æ–≤–Ω–æ–π": false
}
```

### ProcessedInvoice –ø–æ–ª—è

–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –ø–æ–ª—è –º–æ–¥–µ–ª–∏:
```python
supplier_bank_name = Column(String(255), nullable=True)  # –ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞
supplier_bik = Column(String(9), nullable=True)          # –ë–ò–ö –±–∞–Ω–∫–∞
supplier_account = Column(String(20), nullable=True)     # –ù–æ–º–µ—Ä —Å—á–µ—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö:

```
üè¶ Attempting to find bank account: 40702810709270005397
‚úÖ Found bank account in 1C: " –¢–æ—á–∫–∞" –ü–ê–û" –•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –±–∞–Ω–∫ –û—Ç–∫—Ä—ã—Ç–∏–µ"   (–†–∞—Å—á–µ—Ç–Ω—ã–π)
   Bank account GUID: f662f1a8-6aa7-11e6-8d13-00155d006a03
```

---

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è**: –ù–æ–º–µ—Ä —Å—á–µ—Ç–∞ –∏–∑ invoice –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ 1–° –∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ –∑–∞—è–≤–∫–µ
2. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: Graceful degradation - –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è EMPTY_GUID (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
3. **–£–¥–æ–±—Å—Ç–≤–æ**: –§–∏–Ω–∞–Ω—Å–∏—Å—Ç–∞–º –Ω–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –≤—ã–±–∏—Ä–∞—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫–∏–π —Å—á–µ—Ç –≤ 1–°
4. **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å**: –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–∏—Å–∫–∞
5. **–ì–∏–±–∫–æ—Å—Ç—å**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ Owner (string/dict) –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å 1–°

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ (–ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –∏–∑ invoice)

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ:

```python
from app.services.invoice_to_1c_converter import InvoiceTo1CConverter

converter = InvoiceTo1CConverter(odata_client, db)
result = converter.create_expense_request_from_invoice(
    invoice=processed_invoice,
    upload_attachment=True
)
```

–ï—Å–ª–∏ `invoice.supplier_account` –∑–∞–ø–æ–ª–Ω–µ–Ω, —Å–∏—Å—Ç–µ–º–∞:
1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç —Å—á–µ—Ç –≤ 1–°
2. –ü—Ä–∏–≤—è–∂–µ—Ç –µ–≥–æ –∫ –∑–∞—è–≤–∫–µ
3. –ó–∞–ª–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

### –†—É—á–Ω–æ–π –ø–æ–∏—Å–∫ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)

```python
from app.services.odata_1c_client import OData1CClient

client = OData1CClient(...)
account = client.get_bank_account_by_number_and_owner(
    account_number="40702810709270005397",
    owner_guid="c069022c-6aa7-11e6-8d13-00155d006a03"
)

if account:
    print(f"Found: {account.get('Description')}")
    print(f"Ref_Key: {account.get('Ref_Key')}")
else:
    print("Account not found")
```

---

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
cd backend
source venv/bin/activate
unset DEBUG  # –í–∞–∂–Ω–æ! –£–±—Ä–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è DEBUG

python scripts/test_bank_account_lookup.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```
================================================================================
üìä –ò–¢–û–ì–ò –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
================================================================================
–¢–µ—Å—Ç –ø–æ–∏—Å–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å—á–µ—Ç–∞: ‚úÖ PASSED
–¢–µ—Å—Ç –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å—á–µ—Ç–∞: ‚úÖ PASSED
================================================================================

üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!
```

### –ü–æ–∏—Å–∫ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```bash
python scripts/find_counterparty_with_account.py
```

–í—ã–≤–µ–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ 1–° –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö.

---

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–º–µ–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Ä–æ–≤–Ω–µ–π –∑–∞—â–∏—Ç—ã:

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è supplier_account**:
   - –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ, –ø–æ–∏—Å–∫ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è

2. **Try-except –±–ª–æ–∫**:
   - –õ—é–±—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—é—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏
   - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –æ—à–∏–±–∫–∞ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**:
   - –ï—Å–ª–∏ —Å—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (None), –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è EMPTY_GUID
   - –ó–∞—è–≤–∫–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ —Å–æ–∑–¥–∞–µ—Ç—Å—è

4. **Fallback –∫ EMPTY_GUID**:
   - –ü–æ–≤–µ–¥–µ–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ —Å—Ç–∞—Ä–æ–º—É (–¥–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏)
   - –§–∏–Ω–∞–Ω—Å–∏—Å—Ç –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Å—á–µ—Ç –≤—Ä—É—á–Ω—É—é –≤ 1–°

---

## Performance

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ 1–°**: +1 OData –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞–∂–¥–æ–π –∑–∞—è–≤–∫–∏ (–µ—Å–ª–∏ supplier_account –∑–∞–ø–æ–ª–Ω–µ–Ω).

**–¢–∏–ø–∏—á–Ω–æ–µ –≤—Ä–µ–º—è**: ~100-300ms –Ω–∞ –ø–æ–∏—Å–∫ —Å—á–µ—Ç–∞.

**–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:**
- –§–∏–ª—å—Ç—Ä –ø–æ –Ω–æ–º–µ—Ä—É —Å—á–µ—Ç–∞ (–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–ª–µ –≤ 1–°)
- TOP 10 –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- Client-side —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤–ª–∞–¥–µ–ª—å—Ü—É (–±—ã—Å—Ç—Ä–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)

---

## –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤

### –£—Å–ø–µ—à–Ω—ã–π –ø–æ–∏—Å–∫

```
2025-11-20 19:50:07 - INFO - üè¶ Attempting to find bank account: 40702810709270005397
2025-11-20 19:50:07 - DEBUG - Searching bank account by number: 40702810709270005397 for owner: c069022c-6aa7-11e6-8d13-00155d006a03
2025-11-20 19:50:07 - DEBUG - Request URL: http://10.10.100.77/trade/odata/standard.odata/Catalog_–ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ–°—á–µ—Ç–∞–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤?$top=10&$format=json&$filter=–ù–æ–º–µ—Ä–°—á–µ—Ç–∞ eq '40702810709270005397'
2025-11-20 19:50:07 - INFO - Found bank account: " –¢–æ—á–∫–∞" –ü–ê–û" –•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –±–∞–Ω–∫ –û—Ç–∫—Ä—ã—Ç–∏–µ"   (–†–∞—Å—á–µ—Ç–Ω—ã–π) (Ref_Key: f662f1a8-6aa7-11e6-8d13-00155d006a03)
2025-11-20 19:50:07 - INFO - ‚úÖ Found bank account in 1C: " –¢–æ—á–∫–∞" –ü–ê–û" –•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π –±–∞–Ω–∫ –û—Ç–∫—Ä—ã—Ç–∏–µ"   (–†–∞—Å—á–µ—Ç–Ω—ã–π) (Ref_Key: f662f1a8-6aa7-11e6-8d13-00155d006a03)
```

### –°—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω

```
2025-11-20 19:50:07 - INFO - üè¶ Attempting to find bank account: 12345678901234567890
2025-11-20 19:50:07 - WARNING - Bank account 12345678901234567890 not found for owner c069022c-6aa7-11e6-8d13-00155d006a03
2025-11-20 19:50:07 - WARNING - ‚ö†Ô∏è Bank account 12345678901234567890 not found in 1C, using EMPTY_GUID
```

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Backend

- `backend/app/services/odata_1c_client.py` - –ú–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞ —Å—á–µ—Ç–∞
- `backend/app/services/invoice_to_1c_converter.py` - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏
- `backend/app/db/models.py` - –ú–æ–¥–µ–ª—å ProcessedInvoice

### –¢–µ—Å—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã

- `backend/scripts/test_bank_account_lookup.py` - –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã
- `backend/scripts/find_counterparty_with_account.py` - –ü–æ–∏—Å–∫ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- `backend/scripts/check_bank_account_format.py` - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
- `backend/scripts/check_bank_from_existing.py` - –ê–Ω–∞–ª–∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—á–µ—Ç–æ–≤

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `docs/INVOICE_TO_1C_INTEGRATION.md` - –û–±—â–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å 1–°
- `docs/INVOICE_1C_VAT_HANDLING.md` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –ù–î–°
- `docs/BANK_ACCOUNT_LOOKUP_IMPLEMENTATION.md` - –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç

---

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

### –í–æ–∑–º–æ–∂–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤**:
   - –ö—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å—á–µ—Ç–æ–≤
   - –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫—ç—à–∞: 1 —á–∞—Å
   - –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ 1–° –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—á–µ—Ç–æ–≤ –æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞

2. **Batch lookup**:
   - –ü–æ–∏—Å–∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—á–µ—Ç–æ–≤ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
   - –ê–∫—Ç—É–∞–ª—å–Ω–æ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ invoices

3. **Fuzzy matching**:
   - –ü–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –Ω–æ–º–µ—Ä–∞ —Å—á–µ—Ç–∞
   - –£—á–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ–ø–µ—á–∞—Ç–æ–∫ –≤ OCR

4. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å—á–µ—Ç–æ–≤**:
   - –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Å—á–µ—Ç–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î
   - –ü–æ–∏—Å–∫ –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ–π –∫–æ–ø–∏–∏ –±–µ–∑ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ 1–°

### –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

1. **–í—ã–±–æ—Ä —Å—á–µ—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**:
   - –ï—Å–ª–∏ —É –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—á–µ—Ç–æ–≤, –∏—Å–∫–∞—Ç—å —Ç–æ—Ç, —É –∫–æ—Ç–æ—Ä–æ–≥–æ `–≤—Å_–û—Å–Ω–æ–≤–Ω–æ–π = true`

2. **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—á–µ—Ç–∞**:
   - –ï—Å–ª–∏ —Å—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–≤–∞—Ç—å –µ–≥–æ –≤ 1–° –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ invoice (BIK, bank_name –∏ —Ç.–¥.)

3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ —Å—á–µ—Ç–∞**:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –ë–ò–ö –∏ –Ω–æ–º–µ—Ä–∞ —Å—á–µ—Ç–∞ –ø–æ —Ä–æ—Å—Å–∏–π—Å–∫–∏–º –ø—Ä–∞–≤–∏–ª–∞–º
   - –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –∏ —Ç.–¥.

---

## –°—Ç–∞—Ç—É—Å

‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ**: –ë–∞–∑–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–∏—Å–∫–∞ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å—á–µ—Ç–æ–≤
‚úÖ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ**: –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —É—Å–ø–µ—à–Ω–æ
‚úÖ **–ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ**: –ü–æ–ª–Ω–∞—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚úÖ **–ó–∞–∫–æ–º–º–∏—á–µ–Ω–æ**: –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ main –≤–µ—Ç–∫–µ

**Commit**: `ca4b215` - "feat: –î–æ–±–∞–≤–ª–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å—á–µ—Ç–æ–≤ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤"

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ backend (`tail -f backend.log`)
2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç `test_bank_account_lookup.py`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ 1–° —á–µ—Ä–µ–∑ `find_counterparty_with_account.py`

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞**: 1.0
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 2025-11-20
