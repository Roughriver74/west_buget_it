# Changelog - FTP Import Status Update Fix

**–î–∞—Ç–∞:** 2025-11-05
**–ó–∞–¥–∞—á–∞:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞—è–≤–æ–∫ –∏–∑ FTP

---

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞—è–≤–æ–∫ –∏–∑ FTP —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞—è–≤–∫–∏ **–Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å**. –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –∏–∑–º–µ–Ω—è–ª—Å—è –≤ Excel —Ñ–∞–π–ª–µ –Ω–∞ FTP (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å "–ö –æ–ø–ª–∞—Ç–µ" –Ω–∞ "–û–ø–ª–∞—á–µ–Ω–∞"), –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∏–º–ø–æ—Ä—Ç–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `skip_duplicates=True` (—Ä–µ–∂–∏–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å.

### –°—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
```python
if existing:
    if skip_duplicates:
        skipped += 1
        continue  # ‚ùå –ó–∞—è–≤–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–ª–∞—Å—å
```

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:

### –ù–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
```python
if existing:
    if skip_duplicates:
        # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è
        critical_fields = ['status', 'is_paid', 'is_closed', 'amount', 'payment_date', 'comment']
        for field in critical_fields:
            if field in expense_fields:
                setattr(existing, field, expense_fields[field])
        updated += 1  # ‚úÖ –ó–∞—è–≤–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
    else:
        # –ü–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª–µ–π
        for key, value in expense_fields.items():
            setattr(existing, key, value)
        updated += 1
```

---

## üìù –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### 1. `backend/app/services/ftp_import_service.py` (+28 -13 —Å—Ç—Ä–æ–∫)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ú–µ—Ç–æ–¥ `import_expenses()`: –ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞—è–≤–æ–∫
- –î–æ–±–∞–≤–ª–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π –ø—Ä–∏ `skip_duplicates=True`
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–µ—Ç–æ–¥–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è (–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤—Å–µ–≥–¥–∞):**
- `status` - —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
- `is_paid` - —Ñ–ª–∞–≥ –æ–ø–ª–∞—Ç—ã
- `is_closed` - —Ñ–ª–∞–≥ –∑–∞–∫—Ä—ã—Ç–∏—è
- `amount` - —Å—É–º–º–∞
- `payment_date` - –¥–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã
- `comment` - –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π

**–ü–æ–ª—è –ù–ï –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ `skip_duplicates=True`:**
- `category_id` - –∫–∞—Ç–µ–≥–æ—Ä–∏—è (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä—É—á–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—é)
- `contractor_id` - –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç
- `organization_id` - –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è
- `department_id` - –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
- `request_date` - –¥–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞
- `number` - –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏

### 2. `backend/app/api/v1/expenses.py` (+10 -3 —Å—Ç—Ä–æ–∫–∏)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `Field` –∏–∑ pydantic
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ö–µ–º–∞ `FTPImportRequest` —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `skip_duplicates`
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è endpoint `/import/ftp`

### 3. `backend/cron_ftp_import.py` (+2 -2 —Å—Ç—Ä–æ–∫–∏)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏

---

## üìö –ù–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

1. **`docs/FTP_IMPORT_STATUS_UPDATE_FIX.md`**
   - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è
   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API
   - –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è `skip_duplicates`

2. **`docs/FTP_IMPORT_TESTING.md`**
   - –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
   - –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –æ—Ç–∫–∞—Ç—É

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
Import completed: 5 created, 0 updated, 145 skipped  ‚ùå
```
- –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞—è–≤–∫–∏ **–Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∏—Å—å** –¥–∞–∂–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```
Import completed: 5 created, 145 updated, 0 skipped  ‚úÖ
```
- –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è
- –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞—è–≤–∫–∏ **–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è** (—Å—Ç–∞—Ç—É—Å, —Å—É–º–º–∞, –¥–∞—Ç—ã)
- –†—É—á–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è **—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è**

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ (—á–µ—Ä–µ–∑ cron):
```bash
cd backend
python3 cron_ftp_import.py
```

### –ß–µ—Ä–µ–∑ API:
```bash
curl -X POST "http://localhost:8000/api/v1/expenses/import/ftp" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "remote_path": "/Zayavki na raszkhod(spisok) XLSX.xlsx",
    "skip_duplicates": true
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:
```sql
SELECT number, status, amount, payment_date, updated_at
FROM expenses
WHERE imported_from_ftp = true
ORDER BY updated_at DESC
LIMIT 20;
```

---

## üîÑ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

‚úÖ **–ü–æ–ª–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**
- API –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Å—Ç–∞–ª–∏—Å—å —Ç–µ –∂–µ
- –°—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ `skip_duplicates=False`
- Cron –∑–∞–¥–∞—á–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## üìä –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- ‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ (–¥–æ–±–∞–≤–ª–µ–Ω —Ç–æ–ª—å–∫–æ —Ü–∏–∫–ª –ø–æ 6 –ø–æ–ª—è–º)
- ‚úÖ –ö—ç—à –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –ø—Ä–µ–∂–¥–µ

---

## üöÄ –î–µ–ø–ª–æ–π

1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞:**
   ```bash
   python3 -m py_compile backend/app/services/ftp_import_service.py
   python3 -m py_compile backend/app/api/v1/expenses.py
   ```
   ‚úÖ –ë–µ–∑ –æ—à–∏–±–æ–∫

2. **Hot reload:**
   - Backend –∑–∞–ø—É—â–µ–Ω —Å `--reload`
   - –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

3. **Production:**
   ```bash
   git add backend/app/services/ftp_import_service.py
   git add backend/app/api/v1/expenses.py
   git add backend/cron_ftp_import.py
   git add docs/FTP_IMPORT_STATUS_UPDATE_FIX.md
   git add docs/FTP_IMPORT_TESTING.md
   git commit -m "fix: update expense status on FTP re-import"
   git push origin main
   ```

---

## üë• –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ä–æ–ª–∏

- **ADMIN** - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç FTP –∏–º–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- **Cron** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞
- **USER/MANAGER** - –≤–∏–¥—è—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∑–∞—è–≤–æ–∫

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –ò–∑–º–µ–Ω–µ–Ω–∏–µ **–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ **–Ω–µ —Ç—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è frontend**
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ **–Ω–µ –ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏**
- –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è **–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è**

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

- [x] –ö–æ–¥ –∏–∑–º–µ–Ω—ë–Ω
- [x] –°–∏–Ω—Ç–∞–∫—Å–∏—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω
- [x] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [x] –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ–ø–∏—Å–∞–Ω—ã
- [x] Changelog —Å–æ–∑–¥–∞–Ω
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ production –¥–∞–Ω–Ω—ã—Ö
- [ ] –ö–æ–º–º–∏—Ç –∏ push –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π

