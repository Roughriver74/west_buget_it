# Migration Guide - КПИ и ФОТ

Это руководство поможет применить миграции базы данных для системы КПИ и управления ФОТ.

## Проблема

При создании сотрудника возникает ошибка:
```
column "monthly_bonus_base" of relation "employees" does not exist
```

Это означает, что база данных не содержит новые колонки для системы премий и КПИ.

## Решение

### Вариант 1: Автоматическое применение (рекомендуется)

Просто перезапустите приложение:

```bash
./stop.sh   # Остановить сервисы
./run.sh    # Запустить заново - миграции применятся автоматически
```

Скрипт `run.sh` был обновлен и теперь автоматически:
- Устанавливает/обновляет зависимости
- Применяет все миграции базы данных

### Вариант 2: Применение миграций вручную

Используйте специальный скрипт для миграций:

```bash
./migrate.sh
```

Этот скрипт покажет:
- Текущую версию базы данных
- Доступные миграции
- Историю миграций
- Применит все необходимые миграции

### Вариант 3: Прямое использование Alembic

Если вы предпочитаете работать с Alembic напрямую:

```bash
cd backend
source venv/bin/activate  # Для macOS/Linux
# или
venv\Scripts\activate     # Для Windows

# Проверить текущую версию
alembic current

# Посмотреть доступные миграции
alembic history --verbose

# Применить все миграции
alembic upgrade head
```

## Что добавляют миграции

### Миграция 1: `2025_10_27_1200-a1b2c3d4e5f6_add_bonus_types_to_payroll.py`

Добавляет поддержку разных типов премий (месячные, квартальные, годовые):

**В таблицу `employees`:**
- `monthly_bonus_base` - базовая ставка месячной премии
- `quarterly_bonus_base` - базовая ставка квартальной премии
- `annual_bonus_base` - базовая ставка годовой премии

**В таблицу `payroll_plans`:**
- Заменяет `bonus` на `monthly_bonus`, `quarterly_bonus`, `annual_bonus`

**В таблицу `payroll_actuals`:**
- Заменяет `bonus_paid` на `monthly_bonus_paid`, `quarterly_bonus_paid`, `annual_bonus_paid`

### Миграция 2: `2025_10_27_1400-b2c3d4e5f6a7_add_kpi_system_tables.py`

Добавляет полную систему КПИ для отслеживания производительности и расчета премий:

**Новые таблицы:**

1. **`kpi_goals`** - Цели и метрики КПИ
   - Название, описание, категория
   - Целевое значение, вес, статус
   - Привязка к отделу и году

2. **`employee_kpis`** - КПИ сотрудников по периодам
   - Процент выполнения КПИ
   - Типы премий (PERFORMANCE_BASED, FIXED, MIXED)
   - Базовые ставки и рассчитанные премии
   - Разделение на месячные, квартальные и годовые

3. **`employee_kpi_goals`** - Связь сотрудников с целями КПИ
   - Целевое и фактическое значение
   - Процент достижения
   - Вес каждой цели

**Новые enum-типы:**
- `BonusTypeEnum`: PERFORMANCE_BASED, FIXED, MIXED
- `KPIGoalStatusEnum`: DRAFT, ACTIVE, ACHIEVED, NOT_ACHIEVED, CANCELLED

## Проверка успешности миграций

После применения миграций проверьте:

```bash
cd backend
source venv/bin/activate

# Проверить текущую версию
alembic current

# Должна быть: b2c3d4e5f6a7 (head)
```

Или через PostgreSQL:

```bash
docker exec -it it_budget_db psql -U budget_user -d it_budget_db

# В psql:
\d employees
# Должны быть колонки: monthly_bonus_base, quarterly_bonus_base, annual_bonus_base

\d employee_kpis
# Должна существовать таблица employee_kpis

\q
```

## Откат миграций (если нужно)

Если что-то пошло не так, можно откатить миграции:

```bash
cd backend
source venv/bin/activate

# Откат последней миграции
alembic downgrade -1

# Откат до конкретной версии
alembic downgrade 39fcb0613cd9  # версия до добавления премий
```

## Структура системы премий после миграций

После применения миграций система поддерживает:

### 1. Базовые ставки премий (Employee)
- Месячная базовая премия
- Квартальная базовая премия
- Годовая базовая премия

### 2. Типы расчета премий (BonusTypeEnum)
- **PERFORMANCE_BASED** - на основе КПИ (премия = база × КПИ%)
- **FIXED** - фиксированная премия (не зависит от КПИ)
- **MIXED** - смешанная (часть фикс., часть по КПИ)

### 3. КПИ сотрудников (EmployeeKPI)
- Процент выполнения КПИ за период
- Рассчитанные премии на основе КПИ
- Настройки типов премий для каждого периода

### 4. Цели КПИ (KPIGoal)
- Корпоративные цели с весами
- Привязка к отделам
- Отслеживание достижений

## Troubleshooting

### Ошибка: "Target database is not up to date"

```bash
cd backend
source venv/bin/activate
alembic upgrade head
```

### Ошибка: "Can't locate revision identified by..."

База данных и код не синхронизированы. Возможно нужно:

```bash
# Проверить историю миграций
alembic history --verbose

# Применить все миграции заново
alembic upgrade head
```

### Ошибка: "UNIQUE constraint failed" при миграции

Возможно есть дубликаты данных. Проверьте данные в базе или откатите и примените миграцию заново.

### База данных не запущена

```bash
# Проверить статус
docker ps | grep it_budget_db

# Запустить базу данных
docker start it_budget_db

# Или использовать скрипт
./start_postgres.sh
```

## Дополнительная информация

- Все миграции находятся в `backend/alembic/versions/`
- Конфигурация Alembic: `backend/alembic.ini`
- Модели базы данных: `backend/app/db/models.py`
- Схемы Pydantic: `backend/app/schemas/`

## Автоматические миграции при запуске

Начиная с этой версии, скрипт `run.sh` автоматически:

1. ✅ Создает виртуальное окружение (если не существует)
2. ✅ Устанавливает/обновляет все зависимости
3. ✅ Применяет все миграции базы данных
4. ✅ Импортирует данные (если база пустая)
5. ✅ Создает admin пользователя (если не существует)

Поэтому в большинстве случаев достаточно просто выполнить `./run.sh` для обновления системы.
