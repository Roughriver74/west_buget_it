# 📊 Упрощённый план разработки бюджетной системы

## 🎯 Цель
Создать простую систему для:
1. ✅ **Ведения справочника статей расходов** (OPEX/CAPEX)
2. 📝 **Планирования бюджета** по статьям помесячно
3. 💰 **Регистрации фактических расходов** (упрощённая форма)
4. 📊 **Анализа остатков** по статьям (План - Факт = Остаток)
5. 🔮 **Прогнозирования** бюджета на 2026 год

---

## ❌ Что НЕ нужно (убираем из полного плана)

- ❌ Полноценный workflow заявок (статусы: Черновик, К оплате, Оплачена и т.д.)
- ❌ Управление контрагентами как отдельный справочник
- ❌ Управление организациями как отдельный справочник
- ❌ Сложные формы с множеством обязательных полей
- ❌ Массовые операции над заявками

---

## ✅ Упрощённая модель данных

### 1. Статьи расходов (BudgetCategory) - ОСНОВНОЙ СПРАВОЧНИК
```
✅ Оставляем как есть (полный CRUD):
├── id
├── name (уникальное название)
├── type (OPEX | CAPEX)
├── description
└── is_active

Функционал:
✓ Создание новой статьи
✓ Редактирование статьи
✓ Деактивация статьи (soft delete)
✓ Просмотр всех статей с фильтром по типу
```

### 2. План бюджета (BudgetPlan) - ПОМЕСЯЧНОЕ ПЛАНИРОВАНИЕ
```
✅ Расширяем текущую модель:
├── id
├── year (год)
├── month (месяц 1-12)
├── category_id (FK -> статья)
├── planned_amount (запланированная сумма)
└── notes (комментарий к плану)

Дополнительно:
✓ Создание плана на год (автозаполнение 12 месяцев)
✓ Редактирование сумм по месяцам
✓ Копирование плана из предыдущего года
✓ Расчёт итогов по OPEX/CAPEX автоматически
```

### 3. Факт расходов (Expense) - УПРОЩЁННАЯ ФОРМА
```
⚠️ УПРОЩАЕМ - убираем лишние поля:

Минимальные поля:
├── id
├── category_id (FK -> статья) ✅ ОБЯЗАТЕЛЬНО
├── amount (сумма) ✅ ОБЯЗАТЕЛЬНО
├── expense_date (дата расхода) ✅ ОБЯЗАТЕЛЬНО
├── description (описание/комментарий)
├── contractor_name (название контрагента - простой текст, не справочник)
└── created_at

Убираем:
❌ number (номер заявки)
❌ contractor_id (связь со справочником)
❌ organization_id
❌ status (статусы)
❌ payment_date
❌ is_paid
❌ requester
❌ request_date
```

### 4. Прогнозы на 2026 (новая таблица или копия BudgetPlan)
```
Новая таблица: BudgetForecast
├── id
├── year (2026)
├── month
├── category_id
├── forecasted_amount
├── base_year (из какого года копировали)
├── adjustment_coefficient (коэффициент корректировки, например 1.1 = +10%)
└── notes
```

---

## 🎨 Упрощённый UI

### 1. Страница "Справочник статей"
```
Путь: /references/categories

Таблица:
┌─────┬──────────────────────┬────────┬────────────────┬─────────┐
│ ID  │ Название             │ Тип    │ Описание       │ Активна │
├─────┼──────────────────────┼────────┼────────────────┼─────────┤
│ 1   │ Серверы и хостинг    │ OPEX   │ Облачные...    │ ✓       │
│ 2   │ Лицензии ПО          │ OPEX   │ Подписки...    │ ✓       │
│ 3   │ Оборудование         │ CAPEX  │ Компьютеры...  │ ✓       │
└─────┴──────────────────────┴────────┴────────────────┴─────────┘

Действия:
[+ Добавить статью]  [Фильтр: Все / OPEX / CAPEX]

Форма создания/редактирования:
┌─────────────────────────────────────┐
│ Создать статью                      │
├─────────────────────────────────────┤
│ Название: [________________] *      │
│ Тип: ○ OPEX  ○ CAPEX *             │
│ Описание: [________________]        │
│ ☑ Активна                           │
│                                     │
│ [Отмена]  [Сохранить]              │
└─────────────────────────────────────┘
```

### 2. Страница "План бюджета"
```
Путь: /budget/plan

Выбор года: [▼ 2025]  [Копировать из 2024 с коэффициентом: [1.0]]

Таблица (pivot по месяцам):
┌──────────────────────┬─────────┬─────────┬─────────┬─────┬─────────┬──────────┐
│ Статья               │ Тип     │ Янв     │ Фев     │ ... │ Дек     │ Итого    │
├──────────────────────┼─────────┼─────────┼─────────┼─────┼─────────┼──────────┤
│ Серверы и хостинг    │ OPEX    │ 100 000 │ 100 000 │ ... │ 100 000 │ 1 200 000│
│ Лицензии ПО          │ OPEX    │ 50 000  │ 50 000  │ ... │ 50 000  │ 600 000  │
│ Оборудование         │ CAPEX   │ 0       │ 500 000 │ ... │ 0       │ 500 000  │
├──────────────────────┼─────────┼─────────┼─────────┼─────┼─────────┼──────────┤
│ ИТОГО OPEX           │         │ 150 000 │ 150 000 │     │ 150 000 │ 1 800 000│
│ ИТОГО CAPEX          │         │ 0       │ 500 000 │     │ 0       │ 500 000  │
│ ВСЕГО                │         │ 150 000 │ 650 000 │     │ 150 000 │ 2 300 000│
└──────────────────────┴─────────┴─────────┴─────────┴─────┴─────────┴──────────┘

Возможности:
✓ Inline редактирование (клик по ячейке = input)
✓ Автосохранение при потере фокуса
✓ Автоматический расчёт итогов
✓ Копирование из другого года
```

### 3. Страница "Факт расходов"
```
Путь: /expenses/actual

Таблица:
┌────┬────────────┬──────────────────────┬──────────┬──────────────┬─────────────┐
│ ID │ Дата       │ Статья               │ Сумма    │ Контрагент   │ Описание    │
├────┼────────────┼──────────────────────┼──────────┼──────────────┼─────────────┤
│ 1  │ 2025-01-15 │ Серверы и хостинг    │ 95 000   │ AWS          │ Январь      │
│ 2  │ 2025-01-20 │ Лицензии ПО          │ 45 000   │ Microsoft    │ Office 365  │
└────┴────────────┴──────────────────────┴──────────┴──────────────┴─────────────┘

Действия:
[+ Добавить расход]  [Фильтр по дате] [Фильтр по статье]

Упрощённая форма создания:
┌─────────────────────────────────────┐
│ Зарегистрировать расход             │
├─────────────────────────────────────┤
│ Дата: [📅 15.01.2025] *            │
│ Статья: [▼ Серверы и хостинг] *    │
│ Сумма: [95000] ₽ *                 │
│ Контрагент: [AWS]                   │
│ Описание: [Оплата за январь]        │
│                                     │
│ [Отмена]  [Сохранить]              │
└─────────────────────────────────────┘

Всего 2 обязательных поля!
```

### 4. Страница "Остатки по статьям"
```
Путь: /analytics/balance

Выбор периода: [▼ 2025] [▼ Январь-Декабрь]

Таблица:
┌──────────────────────┬─────────┬────────────┬────────────┬────────────┬─────────┐
│ Статья               │ Тип     │ План       │ Факт       │ Остаток    │ % испол.│
├──────────────────────┼─────────┼────────────┼────────────┼────────────┼─────────┤
│ Серверы и хостинг    │ OPEX    │ 1 200 000  │ 1 140 000  │ 60 000     │ 95%     │
│ Лицензии ПО          │ OPEX    │ 600 000    │ 540 000    │ 60 000     │ 90%     │
│ Оборудование         │ CAPEX   │ 500 000    │ 500 000    │ 0          │ 100%    │
├──────────────────────┼─────────┼────────────┼────────────┼────────────┼─────────┤
│ ИТОГО OPEX           │         │ 1 800 000  │ 1 680 000  │ 120 000    │ 93%     │
│ ИТОГО CAPEX          │         │ 500 000    │ 500 000    │ 0          │ 100%    │
│ ВСЕГО                │         │ 2 300 000  │ 2 180 000  │ 120 000    │ 95%     │
└──────────────────────┴─────────┴────────────┴────────────┴────────────┴─────────┘

Цветовая индикация:
🟢 Остаток > 20% (хорошо)
🟡 Остаток 5-20% (внимание)
🔴 Остаток < 5% (критично)
⚫ Перерасход (факт > план)
```

### 5. Страница "Прогноз на 2026"
```
Путь: /budget/forecast

[Создать прогноз на 2026 год на основе 2025]
Коэффициент корректировки: [1.1] (110% от 2025 года)

Таблица аналогична "Плану бюджета"
Возможность ручного редактирования после автозаполнения
```

---

## 📋 План реализации (по приоритетам)

### Этап 1: Справочник статей (0.5 дня)
**Статус: ⏸️ Частично есть backend, нужен UI**

- [ ] 1.1. Создать страницу `/references/categories`
- [ ] 1.2. Компонент таблицы категорий
- [ ] 1.3. Модалка создания категории
- [ ] 1.4. Модалка редактирования категории
- [ ] 1.5. Кнопка деактивации категории
- [ ] 1.6. Тестирование CRUD

**Файлы:**
```
frontend/src/
├── pages/
│   └── CategoriesPage.tsx [NEW]
└── components/
    └── references/
        └── categories/
            ├── CategoryTable.tsx [NEW]
            ├── CategoryCreateModal.tsx [NEW]
            ├── CategoryEditModal.tsx [NEW]
            └── CategoryForm.tsx [NEW]
```

---

### Этап 2: План бюджета (1 день)
**Статус: 🔴 Нужна реализация**

- [ ] 2.1. Доработать backend API для планирования
  - [ ] GET `/api/v1/budget/plan/{year}` - получить план на год
  - [ ] POST `/api/v1/budget/plan/{year}/copy-from/{source_year}` - копирование
  - [ ] PATCH `/api/v1/budget/plan/{year}/{month}/{category_id}` - обновить сумму

- [ ] 2.2. Создать страницу `/budget/plan`
- [ ] 2.3. Pivot таблица с месяцами по колонкам
- [ ] 2.4. Inline редактирование ячеек
- [ ] 2.5. Автосохранение изменений
- [ ] 2.6. Функция копирования из другого года
- [ ] 2.7. Автоматический расчёт итогов

**Файлы:**
```
backend/app/
└── routes/
    └── budget.py [MODIFY]
        - add copy_plan_from_year()
        - add update_plan_cell()

frontend/src/
├── pages/
│   └── BudgetPlanPage.tsx [NEW]
└── components/
    └── budget/
        ├── BudgetPlanTable.tsx [NEW]
        ├── EditableCell.tsx [NEW]
        ├── YearSelector.tsx [NEW]
        └── CopyPlanModal.tsx [NEW]
```

---

### Этап 3: Упрощённая регистрация расходов (0.5 дня)
**Статус: 🟡 Backend есть, нужно упростить UI**

- [ ] 3.1. Упростить модель Expense (миграция БД)
  - [ ] Сделать contractor_id nullable
  - [ ] Сделать organization_id nullable
  - [ ] Удалить или сделать опциональными: number, status, payment_date

- [ ] 3.2. Упростить ExpenseCreateModal
  - [ ] Оставить только: дата, статья, сумма, описание, контрагент (текст)
  - [ ] Убрать все необязательные поля

- [ ] 3.3. Обновить ExpenseTable
  - [ ] Показывать: дата, статья, сумма, контрагент, описание
  - [ ] Убрать колонки: номер, статус, организация

**Файлы:**
```
backend/app/db/
└── models.py [MODIFY]
    - make contractor_id nullable
    - make organization_id nullable

frontend/src/components/expenses/
├── ExpenseCreateModal.tsx [SIMPLIFY]
├── ExpenseEditModal.tsx [SIMPLIFY]
└── ExpenseTable.tsx [SIMPLIFY]
```

---

### Этап 4: Аналитика остатков (0.5 дня)
**Статус: 🟡 Частично есть, нужна детализация**

- [ ] 4.1. Backend API для остатков
  - [ ] GET `/api/v1/analytics/balance` - план/факт/остаток по статьям
  - [ ] Параметры: year, month_from, month_to

- [ ] 4.2. Создать страницу `/analytics/balance`
- [ ] 4.3. Таблица с расчётом остатков
- [ ] 4.4. Цветовая индикация
- [ ] 4.5. Фильтр по периоду

**Файлы:**
```
backend/app/routes/
└── analytics.py [MODIFY]
    - add balance_by_categories()

frontend/src/
├── pages/
│   └── BalancePage.tsx [NEW]
└── components/
    └── analytics/
        ├── BalanceTable.tsx [NEW]
        └── PeriodSelector.tsx [NEW]
```

---

### Этап 5: Прогнозы на 2026 (0.5 дня)
**Статус: 🔴 Новый функционал**

- [ ] 5.1. Backend API для прогнозов
  - [ ] GET `/api/v1/budget/forecast/{year}`
  - [ ] POST `/api/v1/budget/forecast/{year}/generate` - создать на основе прошлого года
  - [ ] PATCH `/api/v1/budget/forecast/{year}/{month}/{category_id}`

- [ ] 5.2. Создать страницу `/budget/forecast`
- [ ] 5.3. Форма генерации прогноза с коэффициентом
- [ ] 5.4. Таблица редактирования прогноза (как план)

**Файлы:**
```
backend/app/
├── db/models.py [ADD BudgetForecast model]
└── routes/forecast.py [NEW]

frontend/src/
├── pages/
│   └── ForecastPage.tsx [NEW]
└── components/
    └── forecast/
        ├── ForecastTable.tsx [NEW]
        └── GenerateForecastModal.tsx [NEW]
```

---

## 🎯 Итоговая навигация

```
Главное меню:
├── 📊 Дашборд (уже есть)
├── 📝 План бюджета [NEW]
│   ├── План на 2025
│   └── Прогноз на 2026 [NEW]
├── 💰 Расходы
│   ├── Факт расходов (упрощённый)
│   └── Остатки по статьям [NEW]
├── 📚 Справочники
│   └── Статьи расходов (категории) [NEW]
└── 📈 Аналитика (уже есть)
```

---

## ⏱️ Общая оценка времени

| Этап | Описание | Время |
|------|----------|-------|
| 1 | Справочник статей | 0.5 дня |
| 2 | План бюджета | 1 день |
| 3 | Упрощённые расходы | 0.5 дня |
| 4 | Аналитика остатков | 0.5 дня |
| 5 | Прогнозы на 2026 | 0.5 дня |
| **Итого** | | **3 дня** |

---

## 🚀 С чего начать?

1. **Сначала**: Справочник статей (самое простое, быстро получить результат)
2. **Потом**: План бюджета (самое важное для тебя)
3. **Далее**: Упростить регистрацию расходов
4. **После**: Аналитика остатков
5. **Финал**: Прогнозы на 2026

---

## ✨ Преимущества упрощённого подхода

✅ **Быстрая разработка** - 3 дня вместо 5-7
✅ **Простой UI** - меньше полей, меньше кликов
✅ **Понятная логика** - план, факт, остаток
✅ **Реальная польза** - только то, что нужно
✅ **Легко поддерживать** - меньше кода, меньше багов

---

## 🎯 Готов начать?

Скажи, с какого этапа начинаем? Рекомендую:
1. **Справочник статей** - быстро сделаем полный CRUD
2. Потом сразу **План бюджета** - сможешь сразу заполнить план на 2025

Или можем сразу начать с Плана бюджета, если статьи уже есть в базе.
