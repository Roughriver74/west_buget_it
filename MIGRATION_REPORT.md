# –û—Ç—á–µ—Ç –æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å UNIQUE constraint

**–î–∞—Ç–∞:** 2025-11-16
**–ú–∏–≥—Ä–∞—Ü–∏—è:** `ae3a6d0c14ea_add_unique_constraint_fin_expense_details`

---

## üìã –ó–∞–¥–∞—á–∞

–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –ø–æ—è–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ `fin_expense_details` –≤ –±—É–¥—É—â–µ–º.

### –ü—Ä–æ–±–ª–µ–º–∞:
- –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞–ø—É—Å–∫–∞–ª—Å—è **8 —Ä–∞–∑**
- –ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å –¥—É–±–ª–∏—Ä–æ–≤–∞–ª–∞—Å—å **8 —Ä–∞–∑** (92,600 –∑–∞–ø–∏—Å–µ–π –≤–º–µ—Å—Ç–æ 11,577)
- –û—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª UNIQUE constraint –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–µ–π

---

## üõ†Ô∏è –†–µ—à–µ–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è Alembic

**–§–∞–π–ª:** `backend/alembic/versions/2025_11_16_0837-ae3a6d0c14ea_add_unique_constraint_fin_expense_.py`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. **–£–¥–∞–ª—è–µ—Ç –¥—É–±–ª–∏** –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∏–Ω–¥–µ–∫—Å–∞:
   ```sql
   DELETE FROM fin_expense_details
   WHERE id NOT IN (
       SELECT MIN(id)
       FROM fin_expense_details
       GROUP BY expense_operation_id, payment_type, payment_amount, department_id
   );
   ```

2. **–°–æ–∑–¥–∞–µ—Ç UNIQUE –∏–Ω–¥–µ–∫—Å:**
   ```sql
   CREATE UNIQUE INDEX ix_fin_expense_details_unique_detail
   ON fin_expense_details (
       expense_operation_id,
       payment_type,
       payment_amount,
       department_id
   );
   ```

### 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

#### –õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î ‚úÖ
```bash
alembic upgrade head
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
- UNIQUE –∏–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞–Ω
- –î—É–±–ª–∏ —É–¥–∞–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

#### –ü—Ä–æ–¥–∞–∫—à–Ω –ë–î ‚úÖ

**–ú–µ—Ç–æ–¥:** –ü—Ä—è–º–æ–π SQL (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–π –∫–æ–¥)

```bash
docker exec budget_db_prod psql -U budget_user -d it_budget_db -c "
CREATE UNIQUE INDEX ix_fin_expense_details_unique_detail
ON fin_expense_details (expense_operation_id, payment_type, payment_amount, department_id);
"

# –û–±–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å–∏—é –º–∏–≥—Ä–∞—Ü–∏–∏
UPDATE alembic_version SET version_num = 'ae3a6d0c14ea';
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ UNIQUE –∏–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞–Ω
- ‚úÖ –í–µ—Ä—Å–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- ‚úÖ Constraint –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω (–ø–æ–ø—ã—Ç–∫–∞ –≤—Å—Ç–∞–≤–∏—Ç—å –¥—É–±–ª—å –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è)

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã constraint

### –¢–µ—Å—Ç –≤—Å—Ç–∞–≤–∫–∏ –¥—É–±–ª—è:
```sql
INSERT INTO fin_expense_details (...)
SELECT ... FROM fin_expense_details LIMIT 1;
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
ERROR: duplicate key value violates unique constraint "ix_fin_expense_details_unique_detail"
DETAIL: Key (expense_operation_id, payment_type, payment_amount, department_id)=(...) already exists.
```

‚úÖ **Constraint —Ä–∞–±–æ—Ç–∞–µ—Ç!** –î—É–±–ª–∏ –±–æ–ª—å—à–µ –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω—ã.

---

## üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∏ –ø–æ—Å–ª–µ

### –õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î

| –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å | –î–æ –º–∏–≥—Ä–∞—Ü–∏–∏ | –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ |
|------------|-------------|----------------|
| –ó–∞–ø–∏—Å–µ–π –≤ fin_expense_details | ~11,600 | ~11,577 |
| UNIQUE –∏–Ω–¥–µ–∫—Å | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å |
| –î—É–±–ª–∏ | ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã | ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω—ã |

### –ü—Ä–æ–¥–∞–∫—à–Ω –ë–î

| –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å | –î–æ –æ—á–∏—Å—Ç–∫–∏ | –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ | –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ |
|------------|------------|---------------|----------------|
| –ó–∞–ø–∏—Å–µ–π | 92,600 | 11,577 | 11,577 |
| –ü–æ–≥–∞—à–µ–Ω–æ —Ç–µ–ª–∞ | 34 –º–ª—Ä–¥ ‚ùå | 4.26 –º–ª—Ä–¥ ‚úÖ | 4.26 –º–ª—Ä–¥ ‚úÖ |
| UNIQUE –∏–Ω–¥–µ–∫—Å | ‚ùå –ù–µ—Ç | ‚ùå –ù–µ—Ç | ‚úÖ –ï—Å—Ç—å |
| –î—É–±–ª–∏ | ‚ùå 81,023 | ‚úÖ 0 | ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω—ã |

---

## üîê –ì–∞—Ä–∞–Ω—Ç–∏–∏

### –ß—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç UNIQUE constraint:

1. ‚úÖ **–î—É–±–ª–∏–∫–∞—Ç—ã –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ**
   - –ï—Å–ª–∏ FTP –∏–º–ø–æ—Ä—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –¥–≤–∞–∂–¥—ã, –≤—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π
   - –ù—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –∏–º–ø–æ—Ä—Ç–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `ON CONFLICT DO NOTHING`

2. ‚úÖ **–†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–µ–π**
   - –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å —Å —Ç–∞–∫–æ–π –∂–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–µ–π –ø–æ–ª–µ–π

3. ‚úÖ **–°–ª—É—á–∞–π–Ω—ã–µ –¥—É–±–ª–∏**
   - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ª—é–±—ã–µ –ø–æ–ø—ã—Ç–∫–∏

### –ß—Ç–æ –ù–ï –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç:

- ‚ö†Ô∏è –†–∞–∑–Ω—ã–µ —Å—É–º–º—ã –¥–ª—è –æ–¥–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ (—ç—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–µ–π—Å)
- ‚ö†Ô∏è –ò–º–ø–æ—Ä—Ç —Å –æ—à–∏–±–∫–∞–º–∏ (–Ω—É–∂–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ –∫–æ–¥–µ)

---

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∫–æ–¥–∞ –∏–º–ø–æ—Ä—Ç–∞

### –¢–µ–∫—É—â–∏–π –∫–æ–¥ (–º–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å –ø—Ä–∏ –¥—É–±–ª—è—Ö):
```python
db.execute(insert(FinExpenseDetail).values(...))
```

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –∫–æ–¥ (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –¥—É–±–ª–∏):
```python
from sqlalchemy.dialects.postgresql import insert

stmt = insert(FinExpenseDetail).values(...)
stmt = stmt.on_conflict_do_nothing(
    index_elements=[
        'expense_operation_id',
        'payment_type',
        'payment_amount',
        'department_id'
    ]
)
db.execute(stmt)
```

–ò–ª–∏ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º:
```python
stmt = stmt.on_conflict_do_update(
    index_elements=[...],
    set_={
        'updated_at': func.now(),
        # –¥—Ä—É–≥–∏–µ –ø–æ–ª—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    }
)
```

---

## ‚úÖ –ò—Ç–æ–≥–∏

### –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

1. ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —É–¥–∞–ª–µ–Ω–∏–µ–º –¥—É–±–ª–µ–π
2. ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î —á–µ—Ä–µ–∑ `alembic upgrade head`
3. ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π SQL
4. ‚úÖ UNIQUE –∏–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
5. ‚úÖ –í–µ—Ä—Å–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ –æ–±–µ–∏—Ö –ë–î
6. ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–æ–º–º–∏—á–µ–Ω—ã –∏ –∑–∞–ø—É—à–µ–Ω—ã –Ω–∞ GitHub

### –°—Ç–∞—Ç—É—Å:

- üü¢ **–õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—â–∏—â–µ–Ω–∞ –æ—Ç –¥—É–±–ª–µ–π
- üü¢ **–ü—Ä–æ–¥–∞–∫—à–Ω –ë–î:** –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞—â–∏—â–µ–Ω–∞ –æ—Ç –¥—É–±–ª–µ–π
- üü° **–ö–æ–¥ –∏–º–ø–æ—Ä—Ç–∞:** –¢—Ä–µ–±—É–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è `ON CONFLICT`

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. ‚è≥ **–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–¥ –∏–º–ø–æ—Ä—Ç–∞** (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ON CONFLICT DO NOTHING`)
2. ‚è≥ **–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω
3. ‚è≥ **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º–ø–æ—Ä—Ç** –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- **–ú–∏–≥—Ä–∞—Ü–∏—è:** [backend/alembic/versions/2025_11_16_0837-ae3a6d0c14ea_add_unique_constraint_fin_expense_.py](backend/alembic/versions/2025_11_16_0837-ae3a6d0c14ea_add_unique_constraint_fin_expense_.py)
- **–û—Ç—á–µ—Ç –æ–± –æ—á–∏—Å—Ç–∫–µ:** [CLEANUP_REPORT.md](CLEANUP_REPORT.md)
- **–°–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏:** [backend/scripts/clean_credit_data.py](backend/scripts/clean_credit_data.py)
- **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:** [docs/CREDIT_PORTFOLIO_DEBUG.md](docs/CREDIT_PORTFOLIO_DEBUG.md)

---

**–í—ã–ø–æ–ª–Ω–µ–Ω–æ:** Claude Code
**–î–∞—Ç–∞:** 2025-11-16
**–ö–æ–º–º–∏—Ç:** 85b68c8
