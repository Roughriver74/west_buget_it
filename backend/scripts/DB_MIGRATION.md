# –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ë–î –Ω–∞ —Å–µ—Ä–≤–µ—Ä

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–µ—Ä–µ–Ω–æ—Å—É –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î –Ω–∞ —Å–µ—Ä–≤–µ—Ä Docker.

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- `pg_dump` –∏ `psql` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ
- –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–µ—Ä—É –ø–æ SSH (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker)
- –ü—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î –∏ –∑–∞–ø–∏—Å—å –≤ —É–¥–∞–ª–µ–Ω–Ω—É—é

---

## –®–∞–≥ 1: –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î

### –í–∞—Ä–∏–∞–Ω—Ç A: –ò—Å–ø–æ–ª—å–∑—É—è —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
cd backend
./scripts/export_db.sh
```

–°–∫—Ä–∏–ø—Ç:
- –°–æ–∑–¥–∞—Å—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `backend/backups/` –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
- –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –ë–î –≤ —Ñ–∞–π–ª `db_export_YYYYMMDD_HHMMSS.sql`
- –ü–æ–∫–∞–∂–µ—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –∏ —Å–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –í–∞—Ä–∏–∞–Ω—Ç B: –í—Ä—É—á–Ω—É—é

```bash
# –î–ª—è Docker PostgreSQL (–ª–æ–∫–∞–ª—å–Ω—ã–π)
pg_dump -h localhost -p 54329 -U budget_user -d it_budget_db \
  --no-owner --no-acl --clean --if-exists \
  -f backup.sql

# –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å: budget_pass
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `--no-owner` - –Ω–µ –≤–∫–ª—é—á–∞—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ –æ–±—ä–µ–∫—Ç–æ–≤
- `--no-acl` - –Ω–µ –≤–∫–ª—é—á–∞—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
- `--clean` - –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã DROP –ø–µ—Ä–µ–¥ CREATE
- `--if-exists` - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å IF EXISTS –ø—Ä–∏ DROP

---

## –®–∞–≥ 2: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä

### –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker —Å –ø—Ä—è–º—ã–º –¥–æ—Å—Ç—É–ø–æ–º –∫ –ë–î:

```bash
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ SCP
scp backend/backups/db_export_*.sql user@your-server:/path/to/backups/

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –ø–µ—Ä–µ–¥–∞—á–∏ —Ñ–∞–π–ª–∞
```

### –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:

1. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ
2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ SSH
3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –ª—é–±—ã–º —É–¥–æ–±–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º (scp, sftp, wget –∏ —Ç.–¥.)

---

## –®–∞–≥ 3: –ò–º–ø–æ—Ä—Ç –≤ –ë–î –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### ‚ö†Ô∏è –í–ê–ñ–ù–û: –°–æ–∑–¥–∞–π—Ç–µ –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–π –ë–î –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!

```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ, –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º
PGPASSWORD=your_password pg_dump -h postgres_host -p 5432 \
  -U budget_user -d it_budget_db \
  -f backup_before_import_$(date +%Y%m%d).sql
```

### –í–∞—Ä–∏–∞–Ω—Ç A: –ò—Å–ø–æ–ª—å–∑—É—è —Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (–∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–æ—Å—Ç—É–ø –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–π –ë–î):

```bash
cd backend
./scripts/import_db.sh /path/to/backups/db_export_20251029_120000.sql
```

–°–∫—Ä–∏–ø—Ç:
- –ü–æ–∫–∞–∂–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –ó–∞–ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
- –í—ã–ø–æ–ª–Ω–∏—Ç –∏–º–ø–æ—Ä—Ç —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ—à–∏–±–æ–∫

### –í–∞—Ä–∏–∞–Ω—Ç B: –í—Ä—É—á–Ω—É—é

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –ë–î –≤ Docker –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–¥–∞–ª–µ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
PGPASSWORD=your_password psql -h postgres_host -p 5432 \
  -U budget_user -d it_budget_db \
  -f db_export_20251029_120000.sql \
  -v ON_ERROR_STOP=1
```

---

## –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö

–ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```sql
-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
SELECT 'departments' as table_name, COUNT(*) as count FROM departments
UNION ALL
SELECT 'users', COUNT(*) FROM users
UNION ALL
SELECT 'expenses', COUNT(*) FROM expenses
UNION ALL
SELECT 'budget_categories', COUNT(*) FROM budget_categories
UNION ALL
SELECT 'employees', COUNT(*) FROM employees;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π
SELECT * FROM expenses ORDER BY created_at DESC LIMIT 10;
```

---

## –í–∞–∂–Ω—ã–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è

### üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–ù–ï –∫–æ–º–º–∏—Ç—å—Ç–µ SQL –¥–∞–º–ø—ã –≤ Git** - –æ–Ω–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
2. –§–∞–π–ª—ã `*.sql` —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `.gitignore`
3. –ü–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ —É–¥–∞–ª–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å —Å–µ—Ä–≤–µ—Ä–∞

### ‚ö†Ô∏è –ú–∏–≥—Ä–∞—Ü–∏–∏

- –°–∫—Ä–∏–ø—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤–∫–ª—é—á–∞–µ—Ç —Å—Ö–µ–º—É –ë–î (—Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü)
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–µ—Ä—Å–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π —Å–æ–≤–ø–∞–¥–∞—é—Ç:
  ```bash
  # –õ–æ–∫–∞–ª—å–Ω–æ
  alembic current

  # –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (–≤ –ª–æ–≥–∞—Ö Docker –∏–ª–∏ —á–µ—Ä–µ–∑ exec)
  alembic current
  ```
- –ï—Å–ª–∏ –≤–µ—Ä—Å–∏–∏ —Ä–∞–∑–Ω—ã–µ, —Å–Ω–∞—á–∞–ª–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏!

### üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± (—Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ, –±–µ–∑ —Å—Ö–µ–º—ã)

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¢–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã–µ (–±–µ–∑ —Å—Ö–µ–º—ã):

```bash
# –≠–∫—Å–ø–æ—Ä—Ç —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã—Ö
pg_dump -h localhost -p 54329 -U budget_user -d it_budget_db \
  --no-owner --no-acl --data-only \
  -f data_only.sql

# –ò–º–ø–æ—Ä—Ç
psql -h postgres_host -p 5432 -U budget_user -d it_budget_db \
  -f data_only.sql
```

–≠—Ç–æ—Ç —Å–ø–æ—Å–æ–± –ø–æ–ª–µ–∑–µ–Ω –µ—Å–ª–∏:
- –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏
- –ù—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ

---

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (—Å fallback –Ω–∞ defaults):

### export_db.sh (–ª–æ–∫–∞–ª—å–Ω–∞—è –ë–î)
```bash
DB_HOST=localhost
DB_PORT=54329
DB_NAME=it_budget_db
DB_USER=budget_user
DB_PASS=budget_pass
```

### import_db.sh (—É–¥–∞–ª–µ–Ω–Ω–∞—è –ë–î)
```bash
DATABASE_HOST=your-postgres-host
DATABASE_PORT=5432
DATABASE_NAME=it_budget_db
DATABASE_USER=budget_user
DATABASE_PASSWORD=your-production-password
```

---

## Troubleshooting

### –û—à–∏–±–∫–∞: "relation already exists"

–ó–Ω–∞—á–∏—Ç —Ç–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø—Ü–∏—é `--clean`:

```bash
pg_dump --clean --if-exists ...
```

### –û—à–∏–±–∫–∞: "permission denied"

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ë–î:

```sql
GRANT ALL PRIVILEGES ON DATABASE it_budget_db TO budget_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO budget_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO budget_user;
```

### –û—à–∏–±–∫–∞: "password authentication failed"

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –ø–∞—Ä–æ–ª—è
2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ pg_hba.conf –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `PGPASSWORD` –∏–ª–∏ —Ñ–∞–π–ª `.pgpass`

---

## –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–î–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ cron:

```bash
# –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±—ç–∫–∞–ø –≤ 3:00 –Ω–æ—á–∏
0 3 * * * cd /app/backend && ./scripts/export_db.sh >> /var/log/db_backup.log 2>&1
```

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- [PostgreSQL Documentation: pg_dump](https://www.postgresql.org/docs/current/app-pgdump.html)
- [PostgreSQL Documentation: pg_restore](https://www.postgresql.org/docs/current/app-pgrestore.html)
- [Alembic Documentation](https://alembic.sqlalchemy.org/)
