# Импорт бюджетных планов

## Скрипт import_budget_version.py

Скрипт для импорта бюджетных планов из Excel в систему планирования (BudgetVersion + BudgetPlanDetail).

### Формат Excel файла

Файл должен содержать следующие колонки:

| Категория | Тип | Январь | Февраль | Март | ... | Декабрь | Обоснование (опционально) |
|-----------|-----|--------|---------|------|-----|---------|---------------------------|
| Сервера и оборудование | CAPEX | 100000 | 50000 | 0 | ... | 75000 | Закупка нового оборудования |
| Аренда ПО | OPEX | 25000 | 25000 | 25000 | ... | 25000 | Лицензии Microsoft |

**Обязательные колонки:**
- `Категория` - название категории (должна существовать в БД для указанного отдела)
- `Тип` - тип расхода: `CAPEX` или `OPEX`
- Колонки месяцев: `Январь`, `Февраль`, `Март`, `Апрель`, `Май`, `Июнь`, `Июль`, `Август`, `Сентябрь`, `Октябрь`, `Ноябрь`, `Декабрь`

**Опциональные колонки:**
- `Обоснование` - текстовое обоснование бюджета

### Использование

```bash
# Базовое использование
python backend/scripts/import_budget_version.py \
  xls/budget_plan_2026.xlsx \
  --year 2026 \
  --department-id 1 \
  --version-name "План 2026 v1"

# С указанием названия сценария
python backend/scripts/import_budget_version.py \
  xls/budget_plan_2026.xlsx \
  --year 2026 \
  --department-id 1 \
  --version-name "Оптимистичный сценарий" \
  --scenario-name "Сценарий роста на 15%"
```

### Параметры

- `file` - путь к Excel файлу (обязательно)
- `--year` - год планирования (обязательно)
- `--department-id` - ID отдела (обязательно)
- `--version-name` - название версии бюджета (обязательно)
- `--scenario-name` - название сценария (опционально, создаст/использует базовый сценарий)

### Процесс импорта

1. Скрипт читает Excel файл
2. Проверяет наличие обязательных колонок
3. Создает или находит базовый сценарий для указанного года
4. Создает новую версию бюджета со статусом DRAFT
5. Для каждой строки:
   - Находит категорию по названию
   - Создает 12 записей BudgetPlanDetail (по одной на каждый месяц)
6. Пересчитывает итоговые суммы версии (total_amount, total_capex, total_opex)
7. Сохраняет все изменения

### После импорта

После успешного импорта версия будет иметь статус `DRAFT` и будет доступна в UI для:
- Редактирования данных
- Отправки на согласование
- Утверждения (для ADMIN/MANAGER)
- Применения к плану бюджета (после утверждения)

### Примечания

- Категории должны быть заранее созданы в системе для указанного отдела
- Скрипт НЕ создает категории автоматически
- Если категория не найдена - строка пропускается с ошибкой
- Пустые значения в колонках месяцев заменяются на 0
- Скрипт создает записи с `calculation_method = MANUAL`
- Можно запускать несколько раз для разных версий одного года

### Получение ID отдела

Для получения ID отдела можно использовать:

```python
# В Python консоли
from app.db.session import SessionLocal
from app.db.models import Department

db = SessionLocal()
departments = db.query(Department).all()
for dept in departments:
    print(f"{dept.id}: {dept.name}")
db.close()
```

Или через SQL:
```sql
SELECT id, name FROM departments;
```

### Пример вывода

```
================================================================================
ИМПОРТ БЮДЖЕТНОГО ПЛАНА
================================================================================

Файл: xls/budget_plan_2026.xlsx
Год: 2026
Отдел ID: 1
Название версии: План 2026 v1

✓ Создан сценарий: Базовый сценарий 2026
✓ Создана версия: План 2026 v1 (v1)
✓ Найдено категорий: 25

================================================================================
РЕЗУЛЬТАТЫ ИМПОРТА
================================================================================

✓ Создано записей: 300
✓ Итого сумма: 5,240,000.00 ₽
  - CAPEX: 1,200,000.00 ₽
  - OPEX: 4,040,000.00 ₽
✓ Версия ID: 42

✓ Импорт завершен успешно!
  Версия ID: 42
  Статус: DRAFT
```

### Устранение ошибок

**"Категория не найдена"**
- Убедитесь, что категория существует в БД для указанного отдела
- Проверьте точное соответствие названия (учитываются пробелы и регистр)

**"Неверный формат суммы"**
- Убедитесь, что в ячейках месяцев находятся числа
- Удалите форматирование валюты в Excel (оставьте только числа)

**"Тип должен быть OPEX или CAPEX"**
- Проверьте колонку "Тип" - должно быть либо CAPEX, либо OPEX (заглавными буквами)
