# Credit Portfolio Data Cleanup Script

## –û–ø–∏—Å–∞–Ω–∏–µ

–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞ (department).

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### 1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É

```bash
ssh root@31.129.107.178
```

### 2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞

```bash
cd /path/to/acme_buget_it/backend
```

### 3. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ

```bash
source venv/bin/activate
```

### 4. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ DRY RUN (–±–µ–∑–æ–ø–∞—Å–Ω–æ)

```bash
python scripts/clean_credit_data.py --department-id 8 --dry-run
```

–≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç —Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ **–ë–ï–ó** —Ä–µ–∞–ª—å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è.

### 5. –ï—Å–ª–∏ –≤—Å—ë –û–ö, –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—É—é –æ—á–∏—Å—Ç–∫—É

```bash
python scripts/clean_credit_data.py --department-id 8
```

**–í–ê–ñ–ù–û:** –°–∫—Ä–∏–ø—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ - –≤–≤–µ–¥–∏—Ç–µ `yes`

## –ß—Ç–æ —É–¥–∞–ª—è–µ—Ç—Å—è

–°–∫—Ä–∏–ø—Ç —É–¥–∞–ª—è–µ—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç–Ω–æ–≥–æ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–∞ –∏–∑ —Å–ª–µ–¥—É—é—â–∏—Ö —Ç–∞–±–ª–∏—Ü (–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ):

1. `fin_expense_details` - –¥–µ—Ç–∞–ª–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ (–ø–æ–≥–∞—à–µ–Ω–∏–µ/–ø—Ä–æ—Ü–µ–Ω—Ç—ã)
2. `fin_expenses` - —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º
3. `fin_receipts` - –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤
4. `fin_contracts` - –¥–æ–≥–æ–≤–æ—Ä—ã
5. `fin_bank_accounts` - –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Å—á–µ—Ç–∞
6. `fin_organizations` - –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
7. `fin_import_logs` - –ª–æ–≥–∏ –∏–º–ø–æ—Ä—Ç–∞

## –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏

–ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã–µ –º–æ–∂–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ —á–µ—Ä–µ–∑:
- FTP –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç (–±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é)
- –†—É—á–Ω–æ–π –∏–º–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ API `/credit-portfolio/import/trigger`

## –ü—Ä–æ–±–ª–µ–º–∞ —Å –¥—É–±–ª—è–º–∏

### –°–∏–º–ø—Ç–æ–º—ã
- –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ "–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤" –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –æ–≥—Ä–æ–º–Ω—ã–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—É–º–º—ã
- –û—Å—Ç–∞—Ç–æ–∫ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ "-15413831348" (–∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è —á–∏—Å–µ–ª)

### –ü—Ä–∏—á–∏–Ω—ã
1. **–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–º–ø–æ—Ä—Ç** - –¥–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞ –≤ 08:00 MSK)
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ UNIQUE constraints** - —Ä–∞–Ω—å—à–µ –Ω–µ –±—ã–ª–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ `operation_id`

### –†–µ—à–µ–Ω–∏–µ
‚úÖ **–£–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏:**
- –î–æ–±–∞–≤–ª–µ–Ω—ã UNIQUE –∏–Ω–¥–µ–∫—Å—ã: `ix_fin_receipts_operation_id`, `ix_fin_expenses_operation_id`
- –î–æ–±–∞–≤–ª–µ–Ω—ã —Å–æ—Å—Ç–∞–≤–Ω—ã–µ UNIQUE: `ix_fin_receipts_operation_dept`, `ix_fin_expenses_operation_dept`
- –ò–º–ø–æ—Ä—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `ON CONFLICT DO NOTHING` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–µ–π

### –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

1. –û—á–∏—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —ç—Ç–∏–º —Å–∫—Ä–∏–ø—Ç–æ–º
2. –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –∑–∞–Ω–æ–≤–æ –ë–ï–ó –¥—É–±–ª–µ–π
3. –ü—Ä–æ–±–ª–µ–º–∞ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Å—É–º–º–∞–º–∏ –∏—Å—á–µ–∑–Ω–µ—Ç

## –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
cd backend
source venv/bin/activate

# Dry run
python scripts/clean_credit_data.py --department-id 2 --dry-run

# –†–µ–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
python scripts/clean_credit_data.py --department-id 2
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –°–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ –ü—Ä–∏ –æ—à–∏–±–∫–µ –≤—Å—ë –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- ‚úÖ Dry run mode –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
- ‚úÖ –ó–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ department_id

## –ü—Ä–∏–º–µ—Ä—ã –≤—ã–≤–æ–¥–∞

### Dry run
```
DRY RUN - Cleaning credit portfolio data for department 8...

üìä fin_expense_details: 11817 records
üìä fin_expenses: 10958 records
üìä fin_receipts: 1492 records
üìä fin_contracts: 52 records
üìä fin_bank_accounts: 8 records
üìä fin_organizations: 6 records
üìä fin_import_logs: 94 records

[DRY RUN] Would delete: 25427 records

‚ö†Ô∏è  This was a dry run. No changes were made.
```

### –†–µ–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
```
Cleaning credit portfolio data for department 8...

üìä fin_expense_details: 11817 records
   ‚úÖ Deleted 11817 records
üìä fin_expenses: 10958 records
   ‚úÖ Deleted 10958 records
...

Total deleted: 25427 records

‚úÖ All data cleaned successfully!

üîÑ Refreshing materialized views...
‚úÖ Materialized views refreshed!
```
